<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Robust Statistics</title>

<script src="RobustStats_practical_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="RobustStats_practical_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="RobustStats_practical_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="RobustStats_practical_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="RobustStats_practical_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="RobustStats_practical_files/navigation-1.1/tabsets.js"></script>
<link href="RobustStats_practical_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="RobustStats_practical_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="practical.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Robust Statistics</h1>
<h4 class="author"><table style='table-layout:fixed;width:100%;border:0;padding:0;margin:0'>
<col width='10%'>
<col width='10%'>
<tr style="border:none">
<td style="display:block;width:100%;text-align:left;vertical-align:bottom;padding:0;margin:0;border:none" nowrap>
<font style='font-style:normal'>Statistics with R</font><br> <a href='https://therbootcamp.github.io/SwR_2019Apr/'> <i class='fas fa-clock' style='font-size:.9em;' ></i> </a> <a href='https://therbootcamp.github.io'> <i class='fas fa-home' style='font-size:.9em;'></i> </a> <a href='mailto:therbootcamp@gmail.com'> <i class='fas fa-envelope' style='font-size: .9em;'></i> </a> <a href='https://www.linkedin.com/company/basel-r-bootcamp/'> <i class='fab fa-linkedin' style='font-size: .9em;'></i> </a> <a href='https://therbootcamp.github.io'> <font style='font-style:normal'>Basel R Bootcamp</font> </a>
</td>
<td style="width:100%;vertical-align:bottom;text-align:right;padding:0;margin:0;border:none">
<img src='https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/by-sa.png' style='height:15px;width:80px'/>
</td>
</tr>
</table></h4>

</div>


<p align="center" width="100%">
<img src="image/avocado_small.png" alt="Trulli" style="width:100%y"> <br> <font style="font-size:10px">from <a href="https://www.self.com/story/how-to-pick-the-best-avocado-every-time">self.com</a></font>
</p>
<div id="section" class="section level1 tabset">
<h1></h1>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>In this practical you’ll explore issues surrounding the topic of robust statistics using a variety of packages (see <em>Functions</em>) tab. You’ll will explore sales of avocados across various locations in the US from 2015 to 2018.</p>
<p>By the end of this practical you will know how to:</p>
<ol style="list-style-type: decimal">
<li>Evaluate regression assumptions.</li>
<li>Run off-the-shelf non-parametric tests.</li>
<li>Run bootstrap analyses.</li>
</ol>
</div>
<div id="tasks" class="section level2">
<h2>Tasks</h2>
<div id="a---setup" class="section level3">
<h3>A - Setup</h3>
<ol style="list-style-type: decimal">
<li>Open your <code>BaselRBootcamp</code> R project. It should already have the folders <code>1_Data</code> and <code>2_Code</code>. Make sure that the data files listed in the <code>Datasets</code> section above are in your <code>1_Data</code> folder</li>
</ol>
<pre class="r"><code># Done!</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Open a new R script. At the top of the script, using comments, write your name and the date. Save it as a new file called <code>robuststats_practical.R</code> in the <code>2_Code</code> folder.</li>
</ol>
<pre class="r"><code># Done!</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Using <code>library()</code> load the <code>tidyverse</code> package (if you don’t have it, you’ll need to install it with <code>install.packages()</code>)!</li>
</ol>
<pre class="r"><code># Load packages necessary for this script
library(tidyverse)
library(lubridate)</code></pre>
<pre><code>
Attaching package: &#39;lubridate&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:base&#39;:

    date</code></pre>
<pre class="r"><code>library(lme4)</code></pre>
<pre><code>Loading required package: Matrix</code></pre>
<pre><code>
Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:tidyr&#39;:

    expand</code></pre>
<pre class="r"><code>library(rsq)
library(moments)
library(boot)
library(quantreg)</code></pre>
<pre><code>Loading required package: SparseM</code></pre>
<pre><code>
Attaching package: &#39;SparseM&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:base&#39;:

    backsolve</code></pre>
<pre class="r"><code>library(Rfit)</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Using the following template, load the <code>avocado.csv</code>, and <code>avocado_cali.csv</code> data sets into R and store them as a new objects called <code>avocado</code>, and <code>avocado_cali</code> (Hint: Don’t type the path directly! Use the “tab” completion!).</li>
</ol>
<pre class="r"><code># Load XXX.csv from the 1_Data folder

XX &lt;- read_csv(file = &quot;XX/XX&quot;)
XX &lt;- read_csv(file = &quot;XX/XX&quot;)</code></pre>
<pre class="r"><code># Load data sets from the 1_Data folder

avocado &lt;- read_csv(file = &quot;1_Data/avocado.csv&quot;)</code></pre>
<pre><code>Parsed with column specification:
cols(
  volume = col_double(),
  volume_index = col_double(),
  price_per_avocado = col_double(),
  type = col_character(),
  temperature = col_double(),
  temperature_usa = col_double(),
  humidity = col_double(),
  humidity_usa = col_double(),
  precipitation = col_double(),
  precipitation_usa = col_double(),
  year = col_double(),
  season = col_character(),
  date = col_date(format = &quot;&quot;),
  region = col_character(),
  longitude = col_double(),
  latitude = col_double()
)</code></pre>
<pre class="r"><code>avocado_cali &lt;- read_csv(file = &quot;1_Data/avocado_cali.csv&quot;)</code></pre>
<pre><code>Parsed with column specification:
cols(
  volume = col_double(),
  volume_index = col_double(),
  price_per_avocado = col_double(),
  type = col_character(),
  temperature = col_double(),
  temperature_usa = col_double(),
  humidity = col_double(),
  humidity_usa = col_double(),
  precipitation = col_double(),
  precipitation_usa = col_double(),
  year = col_double(),
  season = col_character(),
  date = col_date(format = &quot;&quot;),
  region = col_character(),
  longitude = col_double(),
  latitude = col_double()
)</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Take a look at the first few rows of the data sets by printing them to the console.</li>
</ol>
<pre class="r"><code># Print XXX object
XXX</code></pre>
<pre class="r"><code># Print XXX object
avocado</code></pre>
<pre><code># A tibble: 17,573 x 16
   volume volume_index price_per_avoca… type  temperature temperature_usa
    &lt;dbl&gt;        &lt;dbl&gt;            &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;           &lt;dbl&gt;
 1 6.42e4         4.12             1.33 conv…        6.06            9.29
 2 5.49e4         3.99             1.35 conv…       -1.1             4.48
 3 1.18e5         4.63             0.93 conv…        7.11           12.2 
 4 7.90e4         4.29             1.08 conv…        1.5             7.32
 5 5.10e4         3.93             1.28 conv…       -2               6.23
 6 5.60e4         4.01             1.26 conv…        4.43            5.63
 7 8.35e4         4.34             0.99 conv…        4.38            9.56
 8 1.09e5         4.57             0.98 conv…        4.96           10.2 
 9 9.98e4         4.49             1.02 conv…        8.72           14.6 
10 7.43e4         4.24             1.07 conv…        9.06           14.6 
# … with 17,563 more rows, and 10 more variables: humidity &lt;dbl&gt;,
#   humidity_usa &lt;dbl&gt;, precipitation &lt;dbl&gt;, precipitation_usa &lt;dbl&gt;,
#   year &lt;dbl&gt;, season &lt;chr&gt;, date &lt;date&gt;, region &lt;chr&gt;, longitude &lt;dbl&gt;,
#   latitude &lt;dbl&gt;</code></pre>
<pre class="r"><code>avocado_cali</code></pre>
<pre><code># A tibble: 338 x 16
   volume volume_index price_per_avoca… type  temperature temperature_usa
    &lt;dbl&gt;        &lt;dbl&gt;            &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;           &lt;dbl&gt;
 1 5.04e6         8.59             0.9  conv…       15.5             9.29
 2 4.70e6         8.50             0.94 conv…        2.61            4.48
 3 5.26e6         8.64             0.87 conv…       14.4            12.2 
 4 5.78e6         8.76             0.78 conv…        5.93            7.32
 5 4.58e6         8.46             0.91 conv…        9.76            6.23
 6 4.80e6         8.53             0.92 conv…        6.23            5.63
 7 5.76e6         8.75             0.83 conv…        8.33            9.56
 8 5.15e6         8.61             0.98 conv…       10.5            10.2 
 9 5.83e6         8.77             0.95 conv…       14.7            14.6 
10 4.59e6         8.47             1.12 conv…       14.9            14.6 
# … with 328 more rows, and 10 more variables: humidity &lt;dbl&gt;,
#   humidity_usa &lt;dbl&gt;, precipitation &lt;dbl&gt;, precipitation_usa &lt;dbl&gt;,
#   year &lt;dbl&gt;, season &lt;chr&gt;, date &lt;date&gt;, region &lt;chr&gt;, longitude &lt;dbl&gt;,
#   latitude &lt;dbl&gt;</code></pre>
<ol start="7" style="list-style-type: decimal">
<li>Use the the <code>summary()</code> function to print more details on the columns of the data sets.</li>
</ol>
<pre class="r"><code># Show summary of XXX object
summary(XXX)</code></pre>
<pre class="r"><code># Show summary of XXX object
summary(avocado)</code></pre>
<pre><code>     volume          volume_index  price_per_avocado     type          
 Min.   :      85   Min.   :0.16   Min.   :0.44      Length:17573      
 1st Qu.:   10568   1st Qu.:2.77   1st Qu.:1.10      Class :character  
 Median :  100154   Median :4.49   Median :1.37      Mode  :character  
 Mean   :  545560   Mean   :4.47   Mean   :1.41                        
 3rd Qu.:  399422   3rd Qu.:5.76   3rd Qu.:1.67                        
 Max.   :11274749   Max.   :9.65   Max.   :3.25                        
  temperature    temperature_usa    humidity      humidity_usa 
 Min.   :-21.4   Min.   :-3.99   Min.   :  7.4   Min.   :55.9  
 1st Qu.:  6.0   1st Qu.: 6.31   1st Qu.: 63.3   1st Qu.:66.0  
 Median : 14.9   Median :13.01   Median : 74.6   Median :70.8  
 Mean   : 13.6   Mean   :13.47   Mean   : 72.0   Mean   :71.8  
 3rd Qu.: 22.0   3rd Qu.:21.93   3rd Qu.: 84.0   3rd Qu.:77.1  
 Max.   : 37.9   Max.   :26.87   Max.   :100.0   Max.   :89.4  
 precipitation   precipitation_usa      year         season         
 Min.   :  0.0   Min.   : 0.09     Min.   :2015   Length:17573      
 1st Qu.:  0.0   1st Qu.: 1.19     1st Qu.:2015   Class :character  
 Median :  0.1   Median : 1.91     Median :2016   Mode  :character  
 Mean   :  2.8   Mean   : 2.76     Mean   :2016                     
 3rd Qu.:  2.2   3rd Qu.: 3.73     3rd Qu.:2017                     
 Max.   :224.8   Max.   :13.33     Max.   :2018                     
      date               region            longitude         latitude   
 Min.   :2015-01-04   Length:17573       Min.   :-122.7   Min.   :26.1  
 1st Qu.:2015-10-25   Class :character   1st Qu.:-105.0   1st Qu.:34.1  
 Median :2016-08-14   Mode  :character   Median : -85.8   Median :38.6  
 Mean   :2016-08-13                      Mean   : -91.3   Mean   :37.9  
 3rd Qu.:2017-06-04                      3rd Qu.: -78.9   3rd Qu.:41.9  
 Max.   :2018-03-25                      Max.   : -71.1   Max.   :47.7  </code></pre>
<pre class="r"><code>summary(avocado_cali)</code></pre>
<pre><code>     volume          volume_index  price_per_avocado     type          
 Min.   :   70004   Min.   :4.19   Min.   :0.67      Length:338        
 1st Qu.:  140345   1st Qu.:4.78   1st Qu.:1.08      Class :character  
 Median : 1698251   Median :6.67   Median :1.38      Mode  :character  
 Mean   : 3044324   Mean   :6.79   Mean   :1.40                        
 3rd Qu.: 5871189   3rd Qu.:8.78   3rd Qu.:1.66                        
 Max.   :11213596   Max.   :9.64   Max.   :2.58                        
  temperature    temperature_usa    humidity      humidity_usa 
 Min.   :-9.86   Min.   :-3.99   Min.   : 45.1   Min.   :55.9  
 1st Qu.: 5.63   1st Qu.: 6.31   1st Qu.: 62.9   1st Qu.:66.0  
 Median :12.71   Median :13.01   Median : 73.2   Median :70.8  
 Mean   :13.53   Mean   :13.48   Mean   : 73.5   Mean   :71.8  
 3rd Qu.:22.81   3rd Qu.:21.93   3rd Qu.: 83.3   3rd Qu.:77.1  
 Max.   :30.91   Max.   :26.87   Max.   :100.0   Max.   :89.4  
 precipitation  precipitation_usa      year         season         
 Min.   : 0.0   Min.   : 0.09     Min.   :2015   Length:338        
 1st Qu.: 0.0   1st Qu.: 1.19     1st Qu.:2015   Class :character  
 Median : 0.1   Median : 1.91     Median :2016   Mode  :character  
 Mean   : 2.2   Mean   : 2.76     Mean   :2016                     
 3rd Qu.: 1.2   3rd Qu.: 3.73     3rd Qu.:2017                     
 Max.   :42.8   Max.   :13.33     Max.   :2018                     
      date               region            longitude        latitude   
 Min.   :2015-01-04   Length:338         Min.   :-76.5   Min.   :38.3  
 1st Qu.:2015-10-25   Class :character   1st Qu.:-76.5   1st Qu.:38.3  
 Median :2016-08-14   Mode  :character   Median :-76.5   Median :38.3  
 Mean   :2016-08-14                      Mean   :-76.5   Mean   :38.3  
 3rd Qu.:2017-06-04                      3rd Qu.:-76.5   3rd Qu.:38.3  
 Max.   :2018-03-25                      Max.   :-76.5   Max.   :38.3  </code></pre>
<ol start="8" style="list-style-type: decimal">
<li>Use the <code>View()</code> function to view the entire data sets in new windows</li>
</ol>
<pre class="r"><code># View data frame XXX 
View(XXX)</code></pre>
<pre class="r"><code># View data frame XXX 
View(avocado)
View(avocado_cali)
View(avocado_ny)</code></pre>
</div>
<div id="b---assumptions" class="section level3">
<h3>B - Assumptions</h3>
<ol style="list-style-type: decimal">
<li>In this practical, you will be working with a data set containing information on the sales volume of avocados across various areas in the US and over the the last three years. Your initial goal is to predict, whether the sales <code>volume</code> is a function of the <code>price_per_avocado</code>. Begin by running a simple regression on the <code>avocado_cali</code> data set using <code>lm</code> and store the model as <code>m1</code>. See the template below.</li>
</ol>
<p>Note: In this practical, we will be using the basic <code>lm</code> function, rather than the more general <code>lm</code> function.</p>
<pre class="r"><code># regress volume on average price
m1 &lt;- lm(formula = YY ~ XX, 
         data = ZZ)</code></pre>
<pre class="r"><code># regress volume on average price
m1 &lt;- lm(formula = volume ~ price_per_avocado, 
          data = avocado_cali)</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Evaluate the model using <code>summary()</code>. Is the average price a good predictor of volume?</li>
</ol>
<pre class="r"><code># model summary
summary(XX)</code></pre>
<pre class="r"><code># model summary
summary(m1)</code></pre>
<pre><code>
Call:
lm(formula = volume ~ price_per_avocado, data = avocado_cali)

Residuals:
     Min       1Q   Median       3Q      Max 
-4692333 -1486900   351468  1342770  4276676 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)       11577703     371529    31.2   &lt;2e-16 ***
price_per_avocado -6115691     256440   -23.9   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 1840000 on 336 degrees of freedom
Multiple R-squared:  0.629, Adjusted R-squared:  0.628 
F-statistic:  569 on 1 and 336 DF,  p-value: &lt;2e-16</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>According to test yes, the average price strongly predicts volume. However, this does not imply that the relationship between average price and volume is described well by the regression line. Create a simple plot of the average price (x-axis) and volume (y-axis) using the template below.</li>
</ol>
<pre class="r"><code># plot model
plot(x = avocado_cali$XX, 
     y = avocado_cali$YY)

# Add regression line
abline(m1)</code></pre>
<pre class="r"><code># plot model
plot(x = avocado_cali$price_per_avocado, 
     y = avocado_cali$volume)

# Add regression line
abline(m1)</code></pre>
<p><img src="RobustStats_practical_files/figure-html/unnamed-chunk-17-1.png" width="576" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>The plot revealed that the regression is actually not really a good summary of the data. Confirm this by plotting the residuals against the predicted values.</li>
</ol>
<pre class="r"><code># Residual plot
plot(x = predict(XX), 
     y = residuals(XX))</code></pre>
<pre class="r"><code># Residual plot
plot(predict(m1), residuals(m1))</code></pre>
<p><img src="RobustStats_practical_files/figure-html/unnamed-chunk-19-1.png" width="576" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>The model fits the data badly including several serious violations of regression assumptions: Linearity, normality, and heteroscedascity do not seem to hold. One cause for these violations are missing variables. Add one other variable to the regression that contains information on the kind of avocado (see <em>Data</em> tab) and evaluate the model again.</li>
</ol>
<pre class="r"><code># regress volume on average price and XX
m2 &lt;- lm(formula = YY ~ XX1 + XX2, 
         data = ZZ)

plot(x = predict(m2), 
     y = residuals(m2))</code></pre>
<pre class="r"><code># regress volume on average price and XX
m2 &lt;- lm(volume ~ price_per_avocado + type,
          data = avocado_cali)

plot(predict(m2), residuals(m2))</code></pre>
<p><img src="RobustStats_practical_files/figure-html/unnamed-chunk-21-1.png" width="576" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Accounting for the different types of avocados has helped a great deal. The residual plot still does not look ideal. But at least the correlation between predicted values and residuals seems to have substantially decreased. Verify this by comparing the correlations.</li>
</ol>
<pre class="r"><code># compare correlation of predicted values &amp; residals
cor(x = predict(XX), 
    y = residuals(XX))

cor(x = predict(YY), 
    y = residuals(YY))</code></pre>
<pre class="r"><code># compare correlation of predicted values &amp; residals
cor(predict(m1), residuals(m1))</code></pre>
<pre><code>[1] 4.57e-17</code></pre>
<pre class="r"><code>cor(predict(m2), residuals(m2))</code></pre>
<pre><code>[1] -1.55e-16</code></pre>
<ol start="7" style="list-style-type: decimal">
<li>The correlation actually has not come down, because the correlation for <code>m1</code> was despite the visual appearance already zero. Nonetheless, we are moving in the right direction. One other problem for the relationship is the very skewed distribution of <code>volume</code>. Inspect this by plotting a simple histogram of <code>volume</code>.</li>
</ol>
<pre class="r"><code># histogram of volume
hist(x = avocado_cali$XX)</code></pre>
<pre class="r"><code># histogram of volume
hist(x = avocado_cali$volume)</code></pre>
<p><img src="RobustStats_practical_files/figure-html/unnamed-chunk-25-1.png" width="576" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>To deal with this problem one could engage in variable transformations, but it would be better to model the data using an appropriate probability distribution. In the case of counts this typically is a Poisson distribution. Fortunately, we don’t have to do either. There is another variable called <code>volume_index</code> that is much better behaved. Verify this by also creating a histogram of this variable.</li>
</ol>
<pre class="r"><code># histogram of volume_index
hist(x = avocado_cali$XX)</code></pre>
<pre class="r"><code># histogram of volume_index
hist(x = avocado_cali$volume_index)</code></pre>
<p><img src="RobustStats_practical_files/figure-html/unnamed-chunk-27-1.png" width="576" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>The distribution of <code>volume_index</code> is also not ideal, but at least it exhibits much less skewness. Verify this by computing the skewness of both variables using the <code>skewness</code> function from the <code>moments</code> package.</li>
</ol>
<pre class="r"><code># skewness of volume and volume index
skewness(x = avocado_cali$XX)
skewness(x = avocado_cali$YY)</code></pre>
<pre class="r"><code># skewness of volume and volume index
skewness(x = avocado_cali$volume)</code></pre>
<pre><code>[1] 0.249</code></pre>
<pre class="r"><code>skewness(x = avocado_cali$volume_index)</code></pre>
<pre><code>[1] -0.0029</code></pre>
<ol start="10" style="list-style-type: decimal">
<li>Now that you confirmed that <code>volume_index</code> is probably the better variable to model, run a regression predicting <code>volume_index</code> with <code>price_per_avocado</code> and <code>type</code> and call the model <code>m3</code>.</li>
</ol>
<pre class="r"><code># regress volume_index on average price and type
m3 &lt;- lm(formula = YY ~ XX1 + XX2, 
         data = ZZ)</code></pre>
<pre class="r"><code># regress volume_index on average price and type
m3 &lt;- lm(volume_index ~ price_per_avocado + type,
          data = avocado_cali)</code></pre>
<ol start="12" style="list-style-type: decimal">
<li>Now plot the residuals of <code>m3</code> against the predicted values. What do you think have the residuals become more behaved?</li>
</ol>
<pre class="r"><code># evaluate m3
plot(x = predict(m3), 
     y = residuals(m3))</code></pre>
<p><img src="RobustStats_practical_files/figure-html/unnamed-chunk-32-1.png" width="576" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>The residual behavior is still not ideal. There seems to still some skewness differences between low and high predicted values, but now one would not expect anymore that those would substantially alter the results. So, go on and evaluate the model using <code>summary()</code>.</li>
</ol>
<pre class="r"><code># evaluate m3
summary(m3)</code></pre>
<pre><code>
Call:
lm(formula = volume_index ~ price_per_avocado + type, data = avocado_cali)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.5125 -0.1401  0.0209  0.1463  0.6566 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         9.3814     0.0500   187.7   &lt;2e-16 ***
price_per_avocado  -0.5493     0.0429   -12.8   &lt;2e-16 ***
typeorganic        -3.6459     0.0334  -109.0   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.206 on 335 degrees of freedom
Multiple R-squared:  0.989, Adjusted R-squared:  0.989 
F-statistic: 1.58e+04 on 2 and 335 DF,  p-value: &lt;2e-16</code></pre>
</div>
<div id="c---variance-inflation" class="section level3">
<h3>C - Variance inflation</h3>
<ol style="list-style-type: decimal">
<li>In the previous section, you have evaluated the effect of price on volume controlling for the type of avocado. This has shown you that price indeed seems to exert strong influence on volume. Some of this impact, however, could be due to other third variables. For instance, it might be possible that the price simply went up through general inflation, while at the same time avocados became more popular. Control for this and other factors by including in the regression of <code>volume_index</code> the following variables in addition to <code>price_per_avocado</code> and <code>type</code>, <code>date</code>, <code>season</code>, <code>temperature</code>, <code>humidity</code>, <code>precipitation</code>. Call the model <code>m4</code>.</li>
</ol>
<pre class="r"><code># new comprehensive model 4
m4 &lt;- lm(formula = volume_index ~ price_per_avocado + type + date  + season + temperature + humidity + precipitation, 
         data = avocado_cali)</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Evaluate the model using <code>summary()</code> and compare it to the summary of <code>m3</code>. First, is the the effect of price still significant. Second, how have have the estimate changed and the standard error changed?</li>
</ol>
<pre class="r"><code># evaluate m3 and m4
summary(m3)</code></pre>
<pre><code>
Call:
lm(formula = volume_index ~ price_per_avocado + type, data = avocado_cali)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.5125 -0.1401  0.0209  0.1463  0.6566 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         9.3814     0.0500   187.7   &lt;2e-16 ***
price_per_avocado  -0.5493     0.0429   -12.8   &lt;2e-16 ***
typeorganic        -3.6459     0.0334  -109.0   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.206 on 335 degrees of freedom
Multiple R-squared:  0.989, Adjusted R-squared:  0.989 
F-statistic: 1.58e+04 on 2 and 335 DF,  p-value: &lt;2e-16</code></pre>
<pre class="r"><code>summary(m4)</code></pre>
<pre><code>
Call:
lm(formula = volume_index ~ price_per_avocado + type + date + 
    season + temperature + humidity + precipitation, data = avocado_cali)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.4198 -0.0968  0.0009  0.0834  0.6833 

Coefficients:
                   Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        2.74e+00   4.64e-01    5.91  8.7e-09 ***
price_per_avocado -7.73e-01   4.62e-02  -16.73  &lt; 2e-16 ***
typeorganic       -3.52e+00   3.14e-02 -112.00  &lt; 2e-16 ***
date               4.03e-04   2.83e-05   14.25  &lt; 2e-16 ***
seasonspring       1.50e-01   2.80e-02    5.37  1.5e-07 ***
seasonsummer       1.44e-01   3.07e-02    4.70  3.8e-06 ***
seasonwinter       5.59e-02   3.57e-02    1.57   0.1179    
temperature        3.10e-03   1.53e-03    2.02   0.0441 *  
humidity          -1.56e-03   8.92e-04   -1.75   0.0814 .  
precipitation      4.49e-03   1.71e-03    2.62   0.0091 ** 
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.15 on 328 degrees of freedom
Multiple R-squared:  0.995, Adjusted R-squared:  0.994 
F-statistic: 6.6e+03 on 9 and 328 DF,  p-value: &lt;2e-16</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>You will have observed that both the estimate and the standard error went slightly up. The former is a result of the fact that the other variables took account of some variance in the price that is not related to volume. The latter is, as you can verify in the formula on the variance inflation factor, a result of two adversarial factors: (1) a better fit of the model and (2) an increased variance inflation factor. Let’s inspect these two. First, evaluate the residual variance of <code>m3</code> and <code>m4</code> using the template below.</li>
</ol>
<pre class="r"><code># residaul variance of m3 and m4
var_res1 &lt;- var(residuals(XX))
var_res2 &lt;- var(residuals(YY))

var_res1
var_res2</code></pre>
<pre class="r"><code># resdiaul variance of m3 and m4
var_res1 &lt;- var(residuals(m3))
var_res2 &lt;- var(residuals(m4))
var_res1</code></pre>
<pre><code>[1] 0.042</code></pre>
<pre class="r"><code>var_res2</code></pre>
<pre><code>[1] 0.022</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>You’ll see that that the residual variance decreased to about half. According to this the variance of the <span class="math inline">\(beta\)</span> weight (i.e., the square of the standard error should have also halved). Given that it has not, suggests that the variance inflation factor has increased by at least the same amount. Find out! Run two regression predicting <code>price_per_avocado</code>: First, by all other predictors in <code>m3</code>, i.e., <code>type</code>, and call the model <code>m_price1</code>. Second, by all other predictors in <code>m4</code> and call the model <code>m_price2</code>.</li>
</ol>
<pre class="r"><code># predicting price_per_avocado
m_price1 &lt;- lm(formula = price_per_avocado ~ XX, 
               data = avocado_cali)

m_price2 &lt;- lm(formula = price_per_avocado ~ XX + XX  + ..., 
               data = avocado_cali)</code></pre>
<pre class="r"><code># resdiual variance of m3 and m4
m_price1 &lt;- lm(formula = price_per_avocado ~ type, 
               data = avocado_cali)

m_price2 &lt;- lm(formula = price_per_avocado ~ type + date  + season + temperature + humidity + precipitation, 
               data = avocado_cali)</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Next, calculate the <span class="math inline">\(R^2\)</span> value for both models and the variance inflation factor using the template below.</li>
</ol>
<pre class="r"><code># proportion explained variance
rsq1 &lt;- rsq(XX)
rsq2 &lt;- rsq(YY)
rsq1
rsq2

# variance inflation factors
vif1 &lt;- 1 / (1 - rsq1)
vif2 &lt;- 1 / (1 - rsq2)
vif1
vif2</code></pre>
<pre class="r"><code># proportion explained variance
rsq1 &lt;- rsq(m_price1)
rsq2 &lt;- rsq(m_price2)
rsq1</code></pre>
<pre><code>[1] 0.553</code></pre>
<pre class="r"><code>rsq2</code></pre>
<pre><code>[1] 0.794</code></pre>
<pre class="r"><code># variance inflation factors
vif1 &lt;- 1/(1-rsq1)
vif2 &lt;- 1/(1-rsq2)
vif1</code></pre>
<pre><code>[1] 2.24</code></pre>
<pre class="r"><code>vif2</code></pre>
<pre><code>[1] 4.86</code></pre>
<ol start="6" style="list-style-type: decimal">
<li>So, while residual variance decreased from <code>.042</code> to <code>.022</code>, the variance inflation factor increased from <code>2.24</code> to <code>4.86</code>. Using these values we can actually compute the standard errors of <code>price_per_avocado</code> in model <code>m3</code> and <code>m4</code> following the formula on the respective slide. See code below. Confirm that the calculated values correspond to the standard errors in the summary outputs for <code>m1</code> and <code>m2</code>.</li>
</ol>
<p>Note: R determines the standard errors using a correction for degrees of freedom in the calculation of the residual variance. One can account for this by recalculating the residual variance using <span class="math inline">\(\hat\sigma_e^2=\frac{\sum e^2}{n-df-1}\)</span>, with <span class="math inline">\(df=2\)</span> for <code>m3</code> and <span class="math inline">\(df=9\)</span> for <code>m4</code>.</p>
<pre class="r"><code># needed formula elements
var_x &lt;- var(avocado_cali$price_per_avocado)
n &lt;- nrow(avocado_cali)

# without correction -----

# variance and standard error of price in m3
var_beta1 &lt;- (var_res1 / (var_x * (n-1))) * vif1 
sqrt(var_beta1)</code></pre>
<pre><code>[1] 0.0428</code></pre>
<pre class="r"><code># variance and standard error of price in m4
var_beta2 &lt;- (var_res2 / (var_x * (n-1))) * vif2 
sqrt(var_beta2)</code></pre>
<pre><code>[1] 0.0456</code></pre>
<pre class="r"><code># with correction -----

# variance and standard error of price in m3 with correction
var_c_res1 &lt;- sum(residuals(m3)**2) / (n - 2 - 1)
var_beta1 &lt;- (var_c_res1 / (var_x * (n-1))) * vif1 
sqrt(var_beta1)</code></pre>
<pre><code>[1] 0.0429</code></pre>
<pre class="r"><code># variance and standard error of price in m4 with correction
var_c_res2 &lt;- sum(residuals(m4)**2) / (n - 9 - 1)
var_beta2 &lt;- (var_c_res2 / (var_x * (n-1))) * vif2 
sqrt(var_beta2)</code></pre>
<pre><code>[1] 0.0462</code></pre>
<ol start="7" style="list-style-type: decimal">
<li>The above illustrates that including variables regressors in the regression is a double-edged sword. They improve the overall prediction and may uncover more pure relationships, but they will also increase our uncertainty over the true values of the regression weights by increasing the respective standard errors. If you like, see if you can find other combination of predictors that increase or decrease the standard error of the weight for price.</li>
</ol>
</div>
<div id="c---polynomial-effects" class="section level3">
<h3>C - Polynomial effects</h3>
<ol style="list-style-type: decimal">
<li>So far we have assumed that all relationships are completely linear. However, it seems plausible the effect of price could, for instance, be a quadratic one or even of a higher polynomial. Create a regression predicting <code>volume_index</code> by <code>type</code>, <code>price_per_avocado</code>, and the quadratic effect of <code>price_per_avocado</code>. The latter can be included using the function <code>I()</code>. See template below.</li>
</ol>
<pre class="r"><code># linear and quadratic effect of price
m5 &lt;- lm(formula = YY ~ YY + XX + I(XX ^ 2), 
         data = avocado_cali)</code></pre>
<pre class="r"><code># linear and quadratic effect of price
m5 &lt;- lm(formula = volume_index ~ type + price_per_avocado + I(price_per_avocado^2), 
          data = avocado_cali)</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Eva lute the model (<code>m5</code>) using <code>summary()</code>. Is the quadratic effect significant?</li>
</ol>
<pre class="r"><code># linear and quadratic effect of price
summary(m5)</code></pre>
<pre><code>
Call:
lm(formula = volume_index ~ type + price_per_avocado + I(price_per_avocado^2), 
    data = avocado_cali)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.4958 -0.1337  0.0064  0.1417  0.5849 

Coefficients:
                       Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)              9.8686     0.1506   65.51  &lt; 2e-16 ***
typeorganic             -3.6093     0.0346 -104.24  &lt; 2e-16 ***
price_per_avocado       -1.2474     0.2083   -5.99  5.5e-09 ***
I(price_per_avocado^2)   0.2232     0.0652    3.42    7e-04 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.202 on 334 degrees of freedom
Multiple R-squared:  0.99,  Adjusted R-squared:  0.99 
F-statistic: 1.09e+04 on 3 and 334 DF,  p-value: &lt;2e-16</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Test whether the inclusion of the quadratic factor is warranted by testing <code>m5</code> against <code>m3</code> (the model without the quadratic effect) using <code>anova()</code>. Note: <code>anova()</code> performs a deviance test between two models, not an analysis of variance in the classical sense.</li>
</ol>
<pre class="r"><code># evaluate merit of quadratic effect
anova(m3, m5)</code></pre>
<pre class="r"><code># evaluate merit of quadratic effect
summary(m5)</code></pre>
<pre><code>
Call:
lm(formula = volume_index ~ type + price_per_avocado + I(price_per_avocado^2), 
    data = avocado_cali)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.4958 -0.1337  0.0064  0.1417  0.5849 

Coefficients:
                       Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)              9.8686     0.1506   65.51  &lt; 2e-16 ***
typeorganic             -3.6093     0.0346 -104.24  &lt; 2e-16 ***
price_per_avocado       -1.2474     0.2083   -5.99  5.5e-09 ***
I(price_per_avocado^2)   0.2232     0.0652    3.42    7e-04 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.202 on 334 degrees of freedom
Multiple R-squared:  0.99,  Adjusted R-squared:  0.99 
F-statistic: 1.09e+04 on 3 and 334 DF,  p-value: &lt;2e-16</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Yes, the quadratic effect improves the prediction of volume significantly. However, this came again with a substantial downside. You will see that the standard error of the linear effect of price went up dramatically. This is because <code>price_per_avocado</code> and <code>price_per_avocado^2</code> are highly correlated. To prevent this, the quadratic terms are typically centered, as implemented in the template below. Run the regression and compare the results to <code>m5</code>.</li>
</ol>
<pre class="r"><code># linear and quadratic effect of price
m6 &lt;- lm(formula = YY ~ YY + XX + I((XX - mean(XX)) ^2), 
         data = avocado_cali)</code></pre>
<pre class="r"><code># linear and quadratic effect of price
m6 &lt;- lm(volume_index ~ type + price_per_avocado + I((price_per_avocado - mean(price_per_avocado))^2), 
          data = avocado_cali)</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>You’ll see the standard error of the linear effect went back to about where it was in <code>m3</code> or <code>m4</code>. Try out if you can further improve the prediction of volume by including a cubic effect, i.e., <code>XX^3</code>.</li>
</ol>
</div>
<div id="d---non-parametric-tests" class="section level3">
<h3>D - Non-parametric tests</h3>
<ol style="list-style-type: decimal">
<li>Let’s now look at the development of avocado consumption over time. Use the following code to create data sets containing the Cali’ avocado consumption in 2016 and 2017.</li>
</ol>
<pre class="r"><code># Cali avocado volume 2016 &amp; 2017
avocado_cali_2016 &lt;- avocado_cali %&gt;% 
  filter(year == 2016)

avocado_cali_2017 &lt;- avocado_cali %&gt;% 
  filter(year == 2017, 
         week(date) %in% week(avocado_cali_2016$date))</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Now test, whether the consumption has risen from 2016 to 2017 using a paired t-test, i.e., <code>t.test(X, Y, paired = TRUE)</code>. Try this out for both <code>volume</code> and <code>volume_index</code>.</li>
</ol>
<pre class="r"><code># compare Cali avocado volume 2016 &amp; 2017
t.test(x = avocado_cali_2016$XX,
       y = avocado_cali_2017$XX, 
       paired = TRUE)</code></pre>
<pre class="r"><code># compare Cali avocado volume 2016 &amp; 2017
t.test(avocado_cali_2016$volume,
       avocado_cali_2017$volume, paired = TRUE)</code></pre>
<pre><code>
    Paired t-test

data:  avocado_cali_2016$volume and avocado_cali_2017$volume
t = 2, df = 100, p-value = 0.05
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
  -3290 307840
sample estimates:
mean of the differences 
                 152275 </code></pre>
<pre class="r"><code># compare Cali avocado volume_index 2016 &amp; 2017
t.test(avocado_cali_2016$volume_index,
       avocado_cali_2017$volume_index, paired = TRUE)</code></pre>
<pre><code>
    Paired t-test

data:  avocado_cali_2016$volume_index and avocado_cali_2017$volume_index
t = 2, df = 100, p-value = 0.03
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 0.0056 0.0965
sample estimates:
mean of the differences 
                  0.051 </code></pre>
<ol start="3" style="list-style-type: decimal">
<li>For <code>volume_index</code> the result turned out significant, 2017 indeed saw higher avocado consumption than 2016. However, for <code>volume</code> the result did not quite reach significance. This likely has to do with the fact that <code>volume</code> is extremely skewed. To confirm the result, run the same tests using a pared Wilcoxon test, i.e., <code>wilcox.test(XX, YY, paired = TRUE)</code>, which should not be affected by the skewness.</li>
</ol>
<pre class="r"><code># compare Cali avocado volume 2016 &amp; 2017
wilcox.test(x = avocado_cali_2016$XX,
            y = avocado_cali_2017$XX, 
            paired = TRUE)

# compare Cali avocado volume_index 2016 &amp; 2017
wilcox.test(x = avocado_cali_2016$YY,
            y = avocado_cali_2017$YY, 
            paired = TRUE)</code></pre>
<pre class="r"><code># compare Cali avocado volume 2016 &amp; 2017
wilcox.test(avocado_cali_2016$volume,
            avocado_cali_2017$volume, paired = TRUE)</code></pre>
<pre><code>
    Wilcoxon signed rank test with continuity correction

data:  avocado_cali_2016$volume and avocado_cali_2017$volume
V = 3000, p-value = 0.01
alternative hypothesis: true location shift is not equal to 0</code></pre>
<pre class="r"><code># compare Cali avocado volume_index 2016 &amp; 2017
wilcox.test(avocado_cali_2016$volume_index,
            avocado_cali_2017$volume_index, paired = TRUE)</code></pre>
<pre><code>
    Wilcoxon signed rank test with continuity correction

data:  avocado_cali_2016$volume_index and avocado_cali_2017$volume_index
V = 3000, p-value = 0.02
alternative hypothesis: true location shift is not equal to 0</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>In fact, the Wilcoxon test shows significant results for both measures, suggesting that there indeed is a robust difference. Another, even more robust way of testing this is the sign test. Test this using the template below</li>
</ol>
<pre class="r"><code># sign test preparations
signs &lt;- avocado_cali_2017$XX &gt; avocado_cali_2016$XX
n_plus &lt;- sum(signs)
n &lt;- length(signs)

# sign test: p of receiving a larger n_plus than observed
pbinom(q = n_plus, size = n, prob = .5)</code></pre>
<pre class="r"><code># sign test preparations
signs = avocado_cali_2017$volume &gt; avocado_cali_2016$volume
n_plus = sum(signs)
n = length(signs)

# sign test: p of receiving a larger n_plus than observed
pbinom(n_plus, size = n, prob = .5)</code></pre>
<pre><code>[1] 0.0475</code></pre>
<pre class="r"><code># sign test preparations
signs = avocado_cali_2017$volume_index &gt; avocado_cali_2016$volume_index
n_plus = sum(signs)
n = length(signs)

# sign test: p of receiving a larger n_plus than observed
pbinom(n_plus, size = n, prob = .5)</code></pre>
<pre><code>[1] 0.0475</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>The sign test confirms the results. Now, go explore and see whether you can find additional differences between the avocado years of 2016 and 2017 in California.</li>
</ol>
</div>
<div id="e---robust-regression" class="section level3">
<h3>E - Robust regression</h3>
<ol style="list-style-type: decimal">
<li>Remember that the residual distribution of our regression of <code>volume_index</code> on <code>price_per_avocado</code> and <code>type</code> was less than ideal? Take a look again by running the code below.</li>
</ol>
<pre class="r"><code># regress volume_index on average price and type
m3 &lt;- lm(formula = volume_index ~ price_per_avocado + type,
         data = avocado_cali)

plot(x = predict(m3),
     y = residuals(m3))</code></pre>
<p><img src="RobustStats_practical_files/figure-html/unnamed-chunk-57-1.png" width="576" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>The somewhat different residual distributions for high and low predictions suggest that we should take a look at robust regression analyses. Run similar regression models using the <code>rq</code> function from the <code>quantreg</code> package and the <code>rfit</code> function from the <code>Rfit</code> package using the template below.</li>
</ol>
<pre class="r"><code># quantile regression
m3_q &lt;- rq(formula = YY ~ XX + XX, 
           data = ZZ)

# rank-based regression
m3_rb &lt;- rfit(formula = YY ~ XX + XX, 
              data = ZZ)</code></pre>
<pre class="r"><code># quantile regression
m3_q &lt;- rq(formula = volume_index ~ price_per_avocado + type, 
           data = avocado_cali)

# rank-based regression
m3_rb &lt;- rfit(formula = volume_index ~ price_per_avocado + type, 
              data = avocado_cali)</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Compare the results of the original <code>m3</code> model to the two robust regression models using <code>summary()</code> on each model. Are the coefficients much different from each another?</li>
</ol>
<pre class="r"><code># regular regression
summary(m3)</code></pre>
<pre><code>
Call:
lm(formula = volume_index ~ price_per_avocado + type, data = avocado_cali)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.5125 -0.1401  0.0209  0.1463  0.6566 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         9.3814     0.0500   187.7   &lt;2e-16 ***
price_per_avocado  -0.5493     0.0429   -12.8   &lt;2e-16 ***
typeorganic        -3.6459     0.0334  -109.0   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.206 on 335 degrees of freedom
Multiple R-squared:  0.989, Adjusted R-squared:  0.989 
F-statistic: 1.58e+04 on 2 and 335 DF,  p-value: &lt;2e-16</code></pre>
<pre class="r"><code># quantile regression
summary(m3_q)</code></pre>
<pre><code>
Call: rq(formula = volume_index ~ price_per_avocado + type, data = avocado_cali)

tau: [1] 0.5

Coefficients:
                  coefficients lower bd upper bd
(Intercept)        9.433        9.320    9.478  
price_per_avocado -0.590       -0.672   -0.488  
typeorganic       -3.572       -3.704   -3.501  </code></pre>
<pre class="r"><code># rank-based regression
summary(m3_rb)</code></pre>
<pre><code>Call:
rfit.default(formula = volume_index ~ price_per_avocado + type, 
    data = avocado_cali)

Coefficients:
                  Estimate Std. Error t.value p.value    
(Intercept)         9.3919     0.0509   184.5  &lt;2e-16 ***
price_per_avocado  -0.5487     0.0428   -12.8  &lt;2e-16 ***
typeorganic        -3.6200     0.0334  -108.5  &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
Overall Wald Test: 31306 p-value: 0 </code></pre>
<ol start="4" style="list-style-type: decimal">
<li>The solutions of the three model classes were quite similar, right? Now, try the same predicting <code>volume</code> instead of <code>volume_index</code>. Fit regressions using regular regression and the two robust approaches and compare the parameters.</li>
</ol>
<pre class="r"><code># regular regression
m3_2 &lt;- lm(formula = volume ~ price_per_avocado + type, 
           data = avocado_cali)
summary(m3_2)</code></pre>
<pre><code>
Call:
lm(formula = volume ~ price_per_avocado + type, data = avocado_cali)

Residuals:
     Min       1Q   Median       3Q      Max 
-2029523  -338620   -65747   347099  4692280 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        7418161     181045   40.97  &lt; 2e-16 ***
price_per_avocado -1338574     155354   -8.62  2.8e-16 ***
typeorganic       -5012181     121165  -41.37  &lt; 2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 745000 on 335 degrees of freedom
Multiple R-squared:  0.939, Adjusted R-squared:  0.939 
F-statistic: 2.59e+03 on 2 and 335 DF,  p-value: &lt;2e-16</code></pre>
<pre class="r"><code># quantile regression
m3_q_2 &lt;- rq(formula = volume ~ price_per_avocado + type, 
             data = avocado_cali)
summary(m3_q_2)</code></pre>
<pre><code>
Call: rq(formula = volume ~ price_per_avocado + type, data = avocado_cali)

tau: [1] 0.5

Coefficients:
                  coefficients lower bd   upper bd  
(Intercept)         6.06e+06     5.68e+06  1.80e+308
price_per_avocado  -1.54e+05    -3.16e+05  -4.18e+04
typeorganic        -5.64e+06    -6.39e+06  -5.41e+06</code></pre>
<pre class="r"><code># rank-based regression
m3_rb_2 &lt;- rfit(formula = volume ~ price_per_avocado + type, 
                data = avocado_cali)
summary(m3_rb_2)</code></pre>
<pre><code>Call:
rfit.default(formula = volume ~ price_per_avocado + type, data = avocado_cali)

Coefficients:
                  Estimate Std. Error t.value p.value    
(Intercept)        6364041      79963   79.59 &lt; 2e-16 ***
price_per_avocado  -455914      68632   -6.64 1.2e-10 ***
typeorganic       -5453701      53528 -101.88 &lt; 2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
Overall Wald Test: 25548 p-value: 0 </code></pre>
<ol start="5" style="list-style-type: decimal">
<li>The numbers aren’t so easy to compare, but you will be able to confirm that the regular regression coefficients are far of the ones of the other two methods, especially for <code>price_per_avocado</code>. As in most circumstances, the difference is largest between the <code>rq</code> and <code>lm</code> results, with <code>rfit</code> being somewhere in the middle, but closer to <code>rq</code>. Now, as usual, go explore.</li>
</ol>
</div>
<div id="x---advanced-bootstrap" class="section level3">
<h3>X - Advanced: Bootstrap</h3>
<p>Bootstrapping is an amazingly powerful tool to make inferences about the sampling distribution of any statistic you can come up with. Let’s try to use it to come up with standard errors for our favorite regression model: <code>volume_index ~ price_per_avocado + type</code>.</p>
<ol style="list-style-type: decimal">
<li>To use bootstrap, one needs to define a function that calculates the statistics for each of the different bootstrap samples provided to it. See the code below. Notice that the <code>data</code> argument has not been assigned our data set <code>avocado_cali</code> but rather carries the generic <code>data</code>, which will be provided to the function by the <code>boot</code> function. Run the function.</li>
</ol>
<pre class="r"><code># bootstrap function for linear model
boot_lm &lt;- function(data, indices){
  
  data &lt;- data[indices,] # select obs. in bootstrap sample
  
  m &lt;- lm(volume_index ~ price_per_avocado + type, 
          data = data)
  
  coefficients(m)
  }</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>The next step is to run the bootstrap mechanism using the <code>boot</code> function from the <code>boot</code> package to create the bootstrap results. Here we are now providing <code>avocado_cali</code> along with the function defined above and the number of repetitions <code>R</code>. Run the bootstrap.</li>
</ol>
<pre class="r"><code># bootstrap sampling results 
B &lt;- boot(data = avocado_cali, 
          statistic = boot_lm, 
          R = 100)</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Now you can evaluate the results. Print the <code>B</code> object. The output will be slightly different than usual. The column <code>original</code> contains the results of the regression model for the full data (i.e., <code>m3</code>). The column <code>bias</code> contains the differences between the average simulated parameters and the original parameters. If these are large, then this may, among other things, mean that you need to run a larger number of bootstrap samples. Finally, the column <code>std. error</code> contains the standard error across the bootstrap sampling results.</li>
</ol>
<pre class="r"><code># print bootstrap results
B</code></pre>
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
boot(data = avocado_cali, statistic = boot_lm, R = 100)


Bootstrap Statistics :
    original   bias    std. error
t1*    9.381 -0.00513      0.0538
t2*   -0.549  0.00362      0.0454
t3*   -3.646 -0.00153      0.0359</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Finally, compare the standard errors of the <code>m3</code> or the other, robust regression models, to those of the bootstrap.</li>
</ol>
<pre class="r"><code># print bootstrap results
summary(m3)</code></pre>
<pre><code>
Call:
lm(formula = volume_index ~ price_per_avocado + type, data = avocado_cali)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.5125 -0.1401  0.0209  0.1463  0.6566 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         9.3814     0.0500   187.7   &lt;2e-16 ***
price_per_avocado  -0.5493     0.0429   -12.8   &lt;2e-16 ***
typeorganic        -3.6459     0.0334  -109.0   &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.206 on 335 degrees of freedom
Multiple R-squared:  0.989, Adjusted R-squared:  0.989 
F-statistic: 1.58e+04 on 2 and 335 DF,  p-value: &lt;2e-16</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Go explore. Can you figure out how to bootstrap the difference between the volumes of <code>avocado_cali_2016</code> and <code>avocado_cali_2017</code>?</li>
</ol>
</div>
<div id="y---advanced-assumptions-pt.-2" class="section level3">
<h3>Y - Advanced: Assumptions pt. 2</h3>
<p>In this section you can full demonstrate your statistics Jedi-knight skills by analyzing the full <code>avocado</code> data set. Given that the <code>avocado</code> data set contains data from different regions the full data needs to modeled as a mixed model. Your goal is to specify a model that produces a relatively well-behaved looking residual plot, by including any necessary variables from the data set as fixed or random effects. See template below.</p>
<pre class="r"><code># model
mm &lt;- lmer(formula = volume_index ~ XX + (1 | region), 
           data = avocado)

# residual plot
plot(x = predict(mm), y = residuals(m,))</code></pre>
</div>
</div>
<div id="examples" class="section level2">
<h2>Examples</h2>
<pre class="r"><code>library(tidyverse)

# descriptive stats ----------------

library(moments)

var(hwy)      # variance
skewness(hwy) # skewness


# simple regression ----------------

# model
m &lt;- lm(formula = hwy ~ displ, 
        data = mpg)

# evaluate model
summary(m)     # summary results
predict(m)     # predicted/fitted values
residuals(m)   # residual errors
rsq(m)         # r-square 
1 / (1-rsq(m)) # variance inflation factor 

# residual plot
plot(predict(m), residuals(m))


# model comparison ----------------

# model
m1 &lt;- lm(formula = hwy ~ displ, 
         data = mpg)

# model + quadratic effect
m2 &lt;- lm(formula = hwy ~ I(displ^2), 
         data = mpg)

# anova
anova(m1, m2)

# non-parametric tests ----------------

#  split data (not strictly necessary)
mpg_suv     &lt;- mpg %&gt;% filter(class == &#39;suv&#39;)
mpg_compact &lt;- mpg %&gt;% filter(class == &#39;compact&#39;)

# wilcoxon
wilcoxon.test(mpg_suv$hwy, mpg_compact$hwy)

# robust regression ----------------

library(quantreg)
library(Rfit)

# quantile regression
m_q  &lt;- rq(hwy ~ displ, data = mpg)

# rank-based regression
m_rb &lt;- rfit(hwy ~ displ, data = mpg)</code></pre>
</div>
<div id="datasets" class="section level2">
<h2>Datasets</h2>
<table>
<thead>
<tr class="header">
<th align="left">File</th>
<th align="left">Rows</th>
<th align="left">Columns</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><a href="https://therbootcamp.github.io/SwR_2019Apr/1_Data/avocado.csv">avocado.csv</a></td>
<td align="left">17573</td>
<td align="left">16</td>
</tr>
<tr class="even">
<td align="left"><a href="https://therbootcamp.github.io/SwR_2019Apr/1_Data/avocado_cali.csv">avocado_cali.csv</a></td>
<td align="left">338</td>
<td align="left">16</td>
</tr>
</tbody>
</table>
<p>This data was downloaded from the <a href="https://en.wikipedia.org/wiki/Hass_avocado">Hass</a> Avocado Board website for the duration of April 2015 and May 2018. The data contain weekly (reported on Sundays) retail scan data for National retail volume (units) and price. Retail scan data comes directly from retailers’ cash registers based on actual retail sales of Hass avocados. The Average Price (of avocados) in the table reflects a per unit (per avocado) cost. Other varieties of avocados (e.g. greenskins) are not included in this table.</p>
<p>The data set <code>avocado.csv</code> contains the data for all 52 regions. The smaller data set <code>avocado_cali.csv</code> contains the data for only California.</p>
<div id="variable-description" class="section level4">
<h4>Variable description</h4>
<table style="width:75%;">
<colgroup>
<col width="20%" />
<col width="54%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>volume</code></td>
<td align="left">The total number of sold avocados that week.</td>
</tr>
<tr class="even">
<td align="left"><code>volume_index</code></td>
<td align="left">A sales index scaling the sales number to the range of 0 to 10.</td>
</tr>
<tr class="odd">
<td align="left"><code>price_per_avocado</code></td>
<td align="left">The average price of a single avocado.</td>
</tr>
<tr class="even">
<td align="left"><code>type</code></td>
<td align="left">The type of avocado: “conventional” or “organic”.</td>
</tr>
<tr class="odd">
<td align="left"><code>temperature</code></td>
<td align="left">The regional temperature on the day of the data recording.</td>
</tr>
<tr class="even">
<td align="left"><code>temperature_usa</code></td>
<td align="left">The country-wide temperature on the day of the data recording.</td>
</tr>
<tr class="odd">
<td align="left"><code>humidity</code></td>
<td align="left">The regional humidity on the day of the data recording.</td>
</tr>
<tr class="even">
<td align="left"><code>humidity_usa</code></td>
<td align="left">The country-wide humidity on the day of the data recording.</td>
</tr>
<tr class="odd">
<td align="left"><code>precipitation</code></td>
<td align="left">The regional precipitation on the day of the data recording.</td>
</tr>
<tr class="even">
<td align="left"><code>precipitation_usa</code></td>
<td align="left">The country-wide precipitation on the day of the data recording.</td>
</tr>
<tr class="odd">
<td align="left"><code>year</code></td>
<td align="left">The year of the data recording.</td>
</tr>
<tr class="even">
<td align="left"><code>season</code></td>
<td align="left">The season of the data recording.</td>
</tr>
<tr class="odd">
<td align="left"><code>date</code></td>
<td align="left">The date of the data recording.</td>
</tr>
<tr class="even">
<td align="left"><code>region</code></td>
<td align="left">The region for which sales were recorded.</td>
</tr>
<tr class="odd">
<td align="left"><code>longitude</code></td>
<td align="left">The longitude of the region center.</td>
</tr>
<tr class="even">
<td align="left"><code>latitude</code></td>
<td align="left">The latitude of the region center.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="functions" class="section level2">
<h2>Functions</h2>
<div id="packages" class="section level3">
<h3>Packages</h3>
<table>
<thead>
<tr class="header">
<th align="left">Package</th>
<th align="left">Installation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>tidyverse</code></td>
<td align="left"><code>install.packages(&quot;tidyverse&quot;)</code></td>
</tr>
<tr class="even">
<td align="left"><code>lubridate</code></td>
<td align="left"><code>install.packages(&quot;lubridate&quot;)</code></td>
</tr>
<tr class="odd">
<td align="left"><code>moments</code></td>
<td align="left"><code>install.packages(&quot;moments&quot;)</code></td>
</tr>
<tr class="even">
<td align="left"><code>quantreg</code></td>
<td align="left"><code>install.packages(&quot;quantreg&quot;)</code></td>
</tr>
<tr class="odd">
<td align="left"><code>boot</code></td>
<td align="left"><code>install.packages(&quot;boot&quot;)</code></td>
</tr>
<tr class="even">
<td align="left"><code>Rfit</code></td>
<td align="left"><code>install.packages(&quot;Rfit&quot;)</code></td>
</tr>
<tr class="odd">
<td align="left"><code>lme4</code></td>
<td align="left"><code>install.packages(&quot;lme4&quot;)</code></td>
</tr>
<tr class="even">
<td align="left"><code>rsq</code></td>
<td align="left"><code>install.packages(&quot;rsq&quot;)</code></td>
</tr>
</tbody>
</table>
</div>
<div id="functions-1" class="section level3">
<h3>Functions</h3>
<table style="width:83%;">
<colgroup>
<col width="6%" />
<col width="11%" />
<col width="65%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Function</th>
<th align="left">Package</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>lm</code></td>
<td align="left"><code>stats</code></td>
<td align="left">More basic version of <code>glm()</code> for regular regression models.</td>
</tr>
<tr class="even">
<td align="left"><code>summary</code>, <code>rsq</code></td>
<td align="left"><code>base</code></td>
<td align="left">Print model summary / model R-squared</td>
</tr>
<tr class="odd">
<td align="left"><code>predict</code>, <code>residuals</code></td>
<td align="left"><code>stats</code></td>
<td align="left">Extract fitted values / residuals from model object.</td>
</tr>
<tr class="even">
<td align="left"><code>rq</code></td>
<td align="left"><code>quantreg</code></td>
<td align="left">Conduct quantile regression.</td>
</tr>
<tr class="odd">
<td align="left"><code>rfit</code></td>
<td align="left"><code>Rfit</code></td>
<td align="left">Conduct rank-based regression.</td>
</tr>
<tr class="even">
<td align="left"><code>wilcox.test</code></td>
<td align="left"><code>stats</code></td>
<td align="left">Wilcoxon test.</td>
</tr>
<tr class="odd">
<td align="left"><code>pbinom</code></td>
<td align="left"><code>stats</code></td>
<td align="left">Cumulative binomial distribution. Useful for sign-test.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="resources" class="section level2">
<h2>Resources</h2>
<div id="vignettes" class="section level3">
<h3>vignettes</h3>
<p>Links to decent introductory / tutorial papers:</p>
<p><a href="https://therbootcamp.github.io/SwR_2019Apr/_sessions/RobustStats/literature/Berry1993.pdf">Regression assumptions</a>, <a href="https://therbootcamp.github.io/SwR_2019Apr/_sessions/RobustStats/literature/FoxWeisberg2013.pdf">Robust regression</a>, <a href="https://therbootcamp.github.io/SwR_2019Apr/_sessions/RobustStats/literature/KlokeMcKean2012.pdf">Rank-based regression with Rfit</a> <a href="https://therbootcamp.github.io/SwR_2019Apr/_sessions/RobustStats/literature/FoxWeisberg2013.pdf">Bootstrap</a> <a href="https://therbootcamp.github.io/SwR_2019Apr/_sessions/RobustStats/literature/Stine1995.pdf">Variance inflation</a></p>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
