---
title: "Mixed Effects Models"
author: "Statistics with R<br>
  <a href='https://therbootcamp.github.io'>
    Basel R Bootcamp
  </a>
  <br>
  <a href='https://therbootcamp.github.io/SwR_2019Apr/'>
    <i class='fas fa-clock' style='font-size:.9em;'></i>
  </a>&#8239; 
  <a href='https://therbootcamp.github.io'>
    <i class='fas fa-home' style='font-size:.9em;' ></i>
  </a>&#8239;
  <a href='mailto:therbootcamp@gmail.com'>
    <i class='fas fa-envelope' style='font-size: .9em;'></i>
  </a>&#8239;
  <a href='https://www.linkedin.com/company/basel-r-bootcamp/'>
    <i class='fab fa-linkedin' style='font-size: .9em;'></i>
  </a>"
date: "April 2019"
output:
  xaringan::moon_reader:
    css: ["default", "baselrbootcamp.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
---

layout: true

<div class="my-footer">
  <span style="text-align:center">
    <span> 
      <img src="https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/by-sa.png" height=14 style="vertical-align: middle"/>
    </span>
    <a href="https://therbootcamp.github.io/">
      <span style="padding-left:82px"> 
        <font color="#7E7E7E">
          www.therbootcamp.com
        </font>
      </span>
    </a>
    <a href="https://therbootcamp.github.io/">
      <font color="#7E7E7E">
       Statistics with R | April 2019
      </font>
    </a>
    </span>
  </div> 

---

```{r, eval = TRUE, echo = FALSE, warning=F,message=F}
# Code to knit slides

```

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
# see: https://github.com/yihui/xaringan
# install.packages("xaringan")
# see: 
# https://github.com/yihui/xaringan/wiki
# https://github.com/gnab/remark/wiki/Markdown
options(width = 110)
options(digits = 4)

# Load packages
library(tidyverse)
library(lme4)
tomato_df <- read_csv("Tomatometer_dat.csv")
df <- read_csv("MEM_example.csv")
grand_mean <- mean(df$tomatometer)

baselers <- read_csv("https://raw.githubusercontent.com/therbootcamp/baselers/master/inst/extdata/baselers.txt")
baselers <- baselers %>% 
  filter(!is.na(income),!is.na(age),!is.na(height)) %>%
  slice(sample(1:nrow(baselers),1000)) %>% 
  mutate(sex01 = sex == 'male')
source("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_materials/code/baselrbootcamp_palettes.R")
set.seed(102)
x <- rnorm(10)
y <- .7 * x + rnorm(10, sd = .3) + 2
data <- data.frame(x, y)
mod <- lm(y ~ x, data = data)

great_intercept <- mod$coefficients[1]
great_slope <- mod$coefficients[2]
dat_great <- data.frame(x0 = x, x1 = x,
                        y0 = y, y1 = great_intercept + great_slope * x)
great_raw <- ggplot(dat_great, aes(x = x0, y = y0)) + geom_point(col = baselrbootcamp_cols("grey"), size = 2) +
  geom_abline(slope = great_slope, intercept = great_intercept, size = .5, linetype = 3) +
  theme_minimal() + xlim(c(-2, 3)) + ylim(c(0, 5)) +
  labs(subtitle = paste("Or this?"), x = "Predictor", y = "Criterion")
great_err <- great_raw + 
  geom_linerange(data = dat_great, aes(x = x0, ymin = y0, ymax = y1), col = baselrbootcamp_cols("magenta")) +
  geom_point(data = dat_great, aes(x = x0, y = y1, size = 2), col = baselrbootcamp_cols("green"), pch = "X", size = 4) +
  labs(subtitle = paste("Mean Squared Error (MSE) = ", round(mean((dat_great$y1 - dat_great$y0) ^ 2), 2)),
       x = "Predictor", y = "Criterion")


```




# [iid](https://en.wikipedia.org/wiki/Independent_and_identically_distributed_random_variables) Assumption

.pull-left45[
Previous regression models assumed that the data points are independent and identically distributed (<high>iid</high>).

* <high>Independent</high>: The occurrence of one value does not affect the occurrence of another value.
* <high>Identically distributed</high>: All data points stem from the same probability distribution.


Previously considered models are <high>not robust</high> to violations of the independence assumption.


]

.pull-right45[

<img src="image/iid_plot.png" width="100%" style="display: block; margin: auto;" />


]

---

# Example Data

.pull-left45[

In this introduction we will work with the following data:

You are a researcher and want to gauge whether alcohol influences movie ratings on [Rotten Tomatoes](https://www.rottentomatoes.com/).

You let two subjectes rate two movies once when they are sober and once when they've had 4 beers (we'll call this drunk; more alcohol would count as binge drinking and you don't get ethics approval for that.)

* Repeated measures (i.e., within subjects design)
* The same two movies at all time points for both participants


]

.pull-right45[


<img src="image/dat_plot.png" width="100%" style="display: block; margin: auto;" />




]

---

# Example Data

.pull-left45[

Because we have repeated measures, the independence assumption is violated. Several possibilities exist:

<br>

* Run separate regression models so only independent data points are used (<high>no pooling</high>)
* Average repeated measures and run a fixed effects model
* Treat observations as separate and just run a simple regression (<high>complete pooling</high>)
* Use mixed effects model (<high>partial pooling</high>)
we need to controll for this and can do so by using mixed effects models
fixed and random effects


]

.pull-right45[

<img src="image/dat_plot.png" width="100%" style="display: block; margin: auto;" />


]



---

# Mixed Effects

.pull-left35[


Mixed effects models combine two kinds of effects that serve different purposes:


* <high>Fixed effects</high>
* <high>Random effects</high>


]

.pull-right55[


<img src="image/MEM_example.png" width="100%" style="display: block; margin: auto;" />


]

---

# Fixed Effects

.pull-left45[

Fixed effects represent the overall effect (main effect or interaction) of a predictor. For example the effect of a treatment.

So far we only considered "fixed effects only" models (e.g., simple regression, t-tests, ANOVA).

```{r eval = FALSE}

# continuous predictor
FE_cont <- lm(income ~ age,
              data = baselers)

# discrete predictor
FE_disc <- lm(income ~ sex,
              data = baselers)

```


]

.pull-right45[


<p align="center">
```{r, echo = FALSE, fig.width = 4.2, fig.height = 2.7, dpi = 400, out.width = "100%"}
great_err
```
</p>

]

---

# Random Effects

.pull-left45[
With random effects, we can account for random variability in the data that comes from different sources. We are not interested in the concrete instantiation of a particular level.

Random effects:

* are often part of what we want to generalize over
* are always categorical variables (<high>factors</high>)
* are thought to be randomly drawn from the population 

As expressed by [Singmann and Kellen](http://davidkellen.org/wp-content/uploads/2017/04/introduction-mixed-models.pdf):

> By specifying random effects in our model, we are able to factor out the idiosyncasies of our sample and obtain a more general estimate of the fixed effects of interest.


]

.pull-right45[


<img src="image/MEM_example.png" width="100%" style="display: block; margin: auto;" />

]

---

# Fixed Effects Only Model - Math

<br><br><br>
<img src="image/FE_only.png" width="80%" style="display: block; margin: auto;" />


---

# Fixed Effects Only Model - Data Example

<img src="image/FE_plot.png" width="70%" style="display: block; margin: auto;" />




---

# Random Intercepts Model - Math

<br><br><br>
<img src="image/RI_only.png" width="80%" style="display: block; margin: auto;" />


---

# Random Intercepts Model - Data Example

.pull-left45[


<img src="image/subj_RI_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">By-Subject Random Intercepts</figcaption>
</p>


]

.pull-right45[


<img src="image/mov_RI_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">By-Movie Random Intercepts</figcaption>
</p>

]



---

# Random Intercepts and Slopes Model - Math

<br><br><br>
<img src="image/RI_RS.png" width="80%" style="display: block; margin: auto;" />


---

# Random Intercepts and Slopes Model - Data Example

.pull-left45[


<img src="image/subj_RI_RS_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">By-Subject Random Intercepts and Slopes</figcaption>
</p>


]

.pull-right45[


<img src="image/mov_RI_RS_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">By-Movie Random Intercepts and Slopes</figcaption>
</p>


]



---

# Crossed Random Effects Model - Math

<br><br><br>
<img src="image/Cr_RI_RS.png" width="80%" style="display: block; margin: auto;" />


---

# Crossed Random Effects Model - Data Example

<img src="image/cr_RI_RS_plot.png" width="70%" style="display: block; margin: auto;" />


---

# Crossed vs. Nested Random Effects
<br>
.pull-left35[
<img src="image/crossed_RE.png" width="86%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">Crossed Random Effects</figcaption>
</p>

<br><br>

Crossed random effects are all multiple random effects structures that are not nested.

]

.pull-right55[

<img src="image/nested_RE.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">Nested Random Effects</figcaption>
</p>

<br><br>

Every level of the nested factor only appears within a single level of the higher order factor.

]

---

# More on Random Effects

.pull-left45[

* <high>Hierarchical shrinkage</high>: Individual parameter estimates that are on the extremes of the distribution are adjusted (shrinked) towards the mean. Because of this, predicted cell means need not necessarily coincide with the observed cell means.

* Intra-Class Correlation <high>ICC</high>: The ICC is the proportion of within group (random effect) variance of the total variance.


* Random effects parameters are harder to estimate numerically. Thus, mixed effects model much more frequently exhibit the problem of <high>non-convergence</high> than fixed effects only models.

]

.pull-right45[

<img src="image/shrinkage_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">Example of Hierarchical Shrinkage</figcaption>
</p>

]
---

# Keep It Maximal

.pull-left45[

Specifying the correct random effects structure is important. Failure to do so can result in

* biased estimates
* inflate Type I errors

For this reason, you should specify the <high>maximal random effects structure justified by the design</high> [Barr et al., 2014](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3881361/pdf/nihms533954.pdf)

]

.pull-right45[



]

---

# Fitting Mixed Effects Models in R

.pull-left45[

Several packages exist to run mixed effects models in R. Here are some of them:

<br>

| Package| Function|
|:------|:----|
| [lme4](https://CRAN.R-project.org/package=lme4)| `glmer()` / `lmer()`|
| [afex](https://CRAN.R-project.org/package=afex)| `mixed()`|
| [rstanarm](https://CRAN.R-project.org/package=rstanarm)| `stan_glmer()` / `stan_lmer()` |


]

.pull-right45[

<br>

```{r eval = FALSE}
# mixed model using lme4::lmer()

# fixed effects
LMM_out <- lmer(Tomatometer ~ State +
# by-ID random slopes and intercepts
                  (State|ID) +
# by-ID random slopes and intercepts
                  (State|Movie),
# define data
                data = tomato_df)

# show output
summary(LMM_out)
```



]

---

# Specifying Random Effects in <high>lme4</high>



Random effects are specified with a new element to the formulas:


| Formula | Meaning |
|:----------|:-------------------|
| `(1 `&#124;` S)` | Random intercepts by `S` |
| `(1 `&#124;` S) + (1 `&#124;` I)` | Random intercepts by `S` and `I`|
| `(X1 `&#124;` S)` / `(1 + X1`&#124;` S)`| Random intercepts by `S` and random slopes for `X1` by `S` with correlations  |
| `(X1 * X2 `&#124;` S)`| Random intercepts by `S` and random slopes for `X1`, `X2`, and their interaction `X1:X2` by `S` with correlations  |
| `(0 + X1 `&#124;` S)`| Random slopes for `X1`by `S`, no random intercepts |
| `(X1 `&#124;&#124;` S)`| Random intercepts by `S` and random slopes for `X1` by `S` no correlations |
| `(1 `&#124;` S/C)` / `(1 `&#124;` S) + (1 `&#124;` S:C)`| Random intercepts by `S` and `C` with `C` nested under `S` |


---

# Regression <i>applied</i>

.pull-left45[
other error distributions and link functions

]

.pull-right45[


]
---

class: middle, center

<h1><a href="https://therbootcamp.github.io/SwR_2019Apr/_sessions/RegressionI/RegressionI_practical.html">Practical</a></h1>

