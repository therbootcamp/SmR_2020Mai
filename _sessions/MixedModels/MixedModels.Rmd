---
title: "Mixed Effects Models"
author: "Statistics with R<br>
  <a href='https://therbootcamp.github.io'>
    Basel R Bootcamp
  </a>
  <br>
  <a href='https://therbootcamp.github.io/SwR_2019Apr/'>
    <i class='fas fa-clock' style='font-size:.9em;'></i>
  </a>&#8239; 
  <a href='https://therbootcamp.github.io'>
    <i class='fas fa-home' style='font-size:.9em;' ></i>
  </a>&#8239;
  <a href='mailto:therbootcamp@gmail.com'>
    <i class='fas fa-envelope' style='font-size: .9em;'></i>
  </a>&#8239;
  <a href='https://www.linkedin.com/company/basel-r-bootcamp/'>
    <i class='fab fa-linkedin' style='font-size: .9em;'></i>
  </a>"
date: "April 2019"
output:
  xaringan::moon_reader:
    css: ["default", "baselrbootcamp.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
---

layout: true

<div class="my-footer">
  <span style="text-align:center">
    <span> 
      <img src="https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/by-sa.png" height=14 style="vertical-align: middle"/>
    </span>
    <a href="https://therbootcamp.github.io/">
      <span style="padding-left:82px"> 
        <font color="#7E7E7E">
          www.therbootcamp.com
        </font>
      </span>
    </a>
    <a href="https://therbootcamp.github.io/">
      <font color="#7E7E7E">
       Statistics with R | April 2019
      </font>
    </a>
    </span>
  </div> 

---

```{r, eval = TRUE, echo = FALSE, warning=F,message=F}
# Code to knit slides

```

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
# see: https://github.com/yihui/xaringan
# install.packages("xaringan")
# see: 
# https://github.com/yihui/xaringan/wiki
# https://github.com/gnab/remark/wiki/Markdown
options(width = 110)
options(digits = 4)

# Load packages
library(tidyverse)
library(lme4)
tomato_df <- read_csv("1_Data/Tomatometer_dat.csv")
df <- read_csv("MEM_example.csv")
grand_mean <- mean(df$tomatometer)

baselers <- read_csv("https://raw.githubusercontent.com/therbootcamp/baselers/master/inst/extdata/baselers.txt")
baselers <- baselers %>% 
  filter(!is.na(income),!is.na(age),!is.na(height)) %>%
  slice(sample(1:nrow(baselers),1000)) %>% 
  mutate(sex01 = as.numeric(sex == 'male'))
source("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_materials/code/baselrbootcamp_palettes.R")
set.seed(102)
x <- rnorm(10)
y <- .7 * x + rnorm(10, sd = .3) + 2
data <- data.frame(x, y)
mod <- lm(y ~ x, data = data)

great_intercept <- mod$coefficients[1]
great_slope <- mod$coefficients[2]
dat_great <- data.frame(x0 = x, x1 = x,
                        y0 = y, y1 = great_intercept + great_slope * x)
great_raw <- ggplot(dat_great, aes(x = x0, y = y0)) + geom_point(col = baselrbootcamp_cols("grey"), size = 2) +
  geom_abline(slope = great_slope, intercept = great_intercept, size = .5, linetype = 3) +
  theme_minimal() + xlim(c(-2, 3)) + ylim(c(0, 5)) +
  labs(subtitle = paste("Or this?"), x = "Predictor", y = "Criterion")
great_err <- great_raw + 
  geom_linerange(data = dat_great, aes(x = x0, ymin = y0, ymax = y1), col = baselrbootcamp_cols("magenta")) +
  geom_point(data = dat_great, aes(x = x0, y = y1, size = 2), col = baselrbootcamp_cols("green"), pch = "X", size = 4) +
  labs(subtitle = paste("Mean Squared Error (MSE) = ", round(mean((dat_great$y1 - dat_great$y0) ^ 2), 2)),
       x = "Predictor", y = "Criterion")


b0_s1 <- 4
b0_s2 <- 2
b0_s3 <- 7

b1_s1 <- .8
b1_s2 <- .3
b1_s3 <- .4

x_s1 <- rep(c(5, 10, 15, 20, 25, 30), 30)
x_s2 <- rep(c(5, 10, 15, 20, 25, 30), 30)
x_s3 <- rep(c(5, 10, 15, 20, 25, 30), 30)

y_s1 <- b0_s1 + b1_s1 * x_s1 + rnorm(length(x_s1), 0, 5)
y_s2 <- b0_s2 + b1_s2 * x_s2 + rnorm(length(x_s2), 0, 5)
y_s3 <- b0_s3 + b1_s3 * x_s3 + rnorm(length(x_s3), 0, 5)

s_dat <- tibble(
  y = c(y_s1, y_s2, y_s3),
  x = c(x_s1, x_s2, x_s3),
  Site = rep(c("Site 1", "Site 2", "Site 3"), each = length(x_s1))
)


```

# Data Collection Example

<br>

.pull-left45[

<p align = "center">
<img src="image/example1.png" width=450px><br>
</p>

]

.pull-right45[

<p align = "center">
<img src="image/example2.png" width=450px><br>
</p>

]

---


# [IID](https://en.wikipedia.org/wiki/Independent_and_identically_distributed_random_variables) Assumption

.pull-left45[
Previous regression models assumed that the data points are independent and identically distributed (<high>iid</high>).

* <high>Independent</high>: The occurrence of one value does not affect the occurrence of another value.
* <high>Identically distributed</high>: All data points stem from the same probability distribution.


Previously considered models are <high>not robust</high> to violations of the independence assumption.


]

.pull-right45[

<img src="image/iid_plot.png" width="100%" style="display: block; margin: auto;" />


]

---

# Examples of Data Where the IID Assumption Is Violated


.pull-left55[

<br>

- Test of student performance in the PISA study (<high>students within classes within schools within countries</high>).
- Test of a drug in a clinical trial over multiple sites (<high>patients within doctors within sites</high>).
- Test of the best design or taste of different versions of a product with <high>multiple ratings from the same persons</high>.


*Failure to run the statistical model might lead to missleading results, such as overestimation of an effect.*


]

.pull-right35[


<p align = "center">
<img src="image/pisa.png" height=100px><br>
<font style="font-size:10px">from <a href="https://de.wikipedia.org/wiki/PISA-Studien">wikipedia.org</a></font>
</p>

<p align = "center">
<img src="image/multi-arm-trial.jpg" height=100px><br>
<font style="font-size:10px">from <a href="https://www.mssociety.org.uk/research/latest-research/latest-research-news-and-blogs/first-multi-drug-clinical-trial-in-ms-successfully-completed">mssociety.org.uk</a></font>
</p>

<p align = "center">
<img src="image/sweets.jpg" height=100px><br>
<font style="font-size:10px">from <a href="https://londonist.com/london/free-and-cheap/this-5-metre-high-pick-n-mix-wall-has-half-a-tonne-of-free-sweets">londonist.com</a></font>
</p>



]
---


# Example - Clinical Trial Over Multiple Sites

.pull-left45[
<br>

Let's assume we want to evaluate the effect of a drug (in different doses). We have data of a clinical trial over three sites.

Here's how we would run a regression over all sites (but is it a good idea to do so?):

```{r eval = FALSE}

mod <- lm(Effect ~ Dose,
          data = clinical_data)

```


]

.pull-right45[

<br>


<p align="center">
```{r, echo = FALSE, fig.width = 4.2, fig.height = 2.7, dpi = 400, out.width = "100%"}
ggplot(s_dat, aes(x, y)) + 
  geom_point(col = "#606061", alpha = .7) +
  geom_smooth(method = "lm", col = "#EA4B68", se = FALSE) +
  theme_classic() +
  labs(y = "Effect",
       x = "Dose") +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_text(size = 18,face = "bold"),
    axis.line = element_line(size = 1)
  )
```
</p>

]

---

# Example - Clinical Trial Over Multiple Sites

.pull-left45[


Let's assume we want to evaluate the effect of a drug (in different doses). We have data of a clinical trial over three sites.

Here's how we would run one regression per sites (but is it a good idea to do so?):

```{r eval = FALSE}

mod_s1 <- lm(Effect ~ Dose,
             data = clinical_data %>%
               filter(Site == "Site 1"))

mod_s2 <- lm(Effect ~ Dose,
             data = clinical_data %>%
               filter(Site == "Site 2"))

mod_s3 <- lm(Effect ~ Dose,
             data = clinical_data %>%
               filter(Site == "Site 3"))

```


]

.pull-right45[

<br>

<p align="center">
```{r, echo = FALSE, fig.width = 4.2, fig.height = 2.7, dpi = 400, out.width = "100%"}

ggplot(s_dat, aes(x, y, col = Site)) + 
  geom_point(alpha = .7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_classic() +
  labs(y = "Effect",
       x = "Dose") +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_text(size = 18,face = "bold"),
    axis.line = element_line(size = 1)
  )

```
</p>

]


---

# Mixed Effects Model

.pull-left45[

A better way of analysing data where the IID assumption is violated than running separate regressions is to use mixed effects models.


Mixed effects models combine two kinds of effects that serve different purposes:


* <high>Fixed effects</high>
* <high>Random effects</high>


```{r eval = FALSE}
### Structure of a mixed effects model:

            # Fixed effects part
LMM <- lmer(y ~ FE1 + FE2 +
            # Random effects part
              (FE1|RE) + (FE2|RE),
            # Data
            data = df)
```



]

.pull-right45[

<br>

<p align="center">
```{r, echo = FALSE, fig.width = 4.2, fig.height = 2.7, dpi = 400, out.width = "100%", warning=FALSE}

tomato_df <- tomato_df %>%
  mutate(State = factor(State, levels = c("Sober", "Drunk")))

model1<-lmer(Tomatometer ~ State + (State|ID) + (State|Movie), data=tomato_df)

m_line <- fixef(model1)

# visualize model fit
fittednorms<-ranef(model1)$ID[,1:2]
fittednorms[,1]<-fittednorms[,1]+getME(model1,"beta")[1]
fittednorms[,2]<-fittednorms[,2]+getME(model1,"beta")[2]
colnames(fittednorms)<-c("intercept","slope")

set.seed(25)
rand10<-sample(1:200, 15, replace = FALSE)

ggplot(tomato_df, aes(State, Tomatometer))+
  geom_point(colour= "#606061", alpha = .15, size = 2.5)+
  # geom_segment(aes(x = 1, y = intercept,xend=2, yend=intercept+slope ),
  #              data=fittednorms,colour = "gray85", size = 1)+
  geom_segment(aes(x = 1, y = intercept,xend=2, yend=intercept+slope ),
               data=fittednorms[rand10,],colour = "#EA4B68", size = 1.5,
               alpha = .8)+
  geom_segment(aes(x = 1, y = m_line[1], xend = 2, yend = sum(m_line)),
               data=fittednorms[rand10,],colour = "black", size = 2,
               alpha = 1)+
  theme_classic() +
  labs(
    x = "",
    y = ""
  ) +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_text(size = 18,face = "bold"),
    axis.line = element_line(size = 1.1)
  )

```
</p>

]

---

# Fixed Effects

.pull-left45[

<br>

Fixed effects represent the overall effect (main effect or interaction) of a predictor. For example the effect of a treatment.

So far we only considered "fixed effects only" models (e.g., simple regression, t-tests, ANOVA).

```{r eval = FALSE}

# continuous predictor
mod <- lm(Effect ~ Dose,
          data = clinical_data)

```


]

.pull-right45[

<br>

<p align="center">
```{r, echo = FALSE, fig.width = 4.2, fig.height = 2.7, dpi = 400, out.width = "100%"}
ggplot(s_dat, aes(x, y)) + 
  geom_point(col = "#606061", alpha = .7) +
  geom_smooth(method = "lm", col = "#EA4B68", se = FALSE) +
  theme_classic() +
  labs(y = "Effect",
       x = "Dose") +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_text(size = 18,face = "bold"),
    axis.line = element_line(size = 1)
  )
```
</p>

]

---

# Example Data

.pull-left45[

In this introduction we will work with the following data:

You are a researcher and want to gauge whether alcohol influences movie ratings on [Rotten Tomatoes](https://www.rottentomatoes.com/).

You let two subjects rate two movies once when they are sober and once when they've had 4 beers (we'll call this drunk; more alcohol would count as binge drinking and you don't get ethics approval for that.)

* Repeated measures (i.e., within subjects design)
* The same two movies at all time points for both participants


]

.pull-right45[


<img src="image/dat_plot.png" width="100%" style="display: block; margin: auto;" />




]



---


# Fixed Effects Only Model

<img src="image/FE_plot.png" width="70%" style="display: block; margin: auto;" />


---

# Random Effects

.pull-left45[
With random effects, we can account for random variability in the data that comes from different sources. We are usually not interested in the concrete instantiation of a particular level.

Random effects:

* are often part of what we want to generalize over
* are always categorical variables (<high>factors</high>)
* are thought to be randomly drawn from the population 

As expressed by [Singmann and Kellen](http://davidkellen.org/wp-content/uploads/2017/04/introduction-mixed-models.pdf):

> By specifying random effects in our model, we are able to factor out the idiosyncasies of our sample and obtain a more general estimate of the fixed effects of interest.


]

.pull-right45[


<img src="image/MEM_example.png" width="100%" style="display: block; margin: auto;" />

]


---

# Random Intercepts Model

.pull-left45[


<img src="image/subj_RI_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">By-Subject Random Intercepts</figcaption>
</p>


]

.pull-right45[


<img src="image/mov_RI_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">By-Movie Random Intercepts</figcaption>
</p>

]


---

# Random Intercepts and Slopes Model

.pull-left45[


<img src="image/subj_RI_RS_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">By-Subject Random Intercepts and Slopes</figcaption>
</p>


]

.pull-right45[


<img src="image/mov_RI_RS_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">By-Movie Random Intercepts and Slopes</figcaption>
</p>


]


---

# Crossed Random Effects Model

<img src="image/cr_RI_RS_plot.png" width="70%" style="display: block; margin: auto;" />

---

# Mixed Effects Model - Equations (In Case You Like Them)

<br><br><br>
<img src="image/Cr_RI_RS.png" width="80%" style="display: block; margin: auto;" />

---

# Crossed vs. Nested Random Effects
<br>
.pull-left35[
<img src="image/crossed_RE.png" width="85%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">Crossed Random Effects</figcaption>
</p>

<br><br>

Crossed random effects are all multiple random effects structures that are not nested.

]

.pull-right55[

<img src="image/nested_RE.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">Nested Random Effects</figcaption>
</p>

<br><br>

Every level of the nested factor only appears within a single level of the higher order factor.

]

---

# More on Random Effects

.pull-left45[

* <high>Hierarchical shrinkage</high>: Random effects are adjusted (shrinked) towards the mean. Because of this, predicted cell means need not necessarily coincide with the observed cell means.

* Intra-Class Correlation <high>ICC</high>: The ICC is the proportion of variance explained by a grouping factor (random effect).


* Random effects parameters are harder to estimate numerically. Thus, mixed effects model much more frequently exhibit the problem of <high>non-convergence</high> than fixed effects only models.

]

.pull-right45[

<img src="image/shrinkage_plot.png" width="100%" style="display: block; margin: auto;" />
<p align = "center">
<figcaption align = "center" style="display: block; margin: auto;">Example of Hierarchical Shrinkage</figcaption>
</p>

]
---

# Keep It Maximal

.pull-left45[

Specifying the correct random effects structure is important. Failure to do so can result in inflated Type I errors.

Therefore, it has been argued that one should specify the <high>maximal random effects structure justified by the design</high> (maximal model; [Barr et al., 2014](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3881361/pdf/nihms533954.pdf)).

On the other hand, specifying the random effects structure when it is not apparent in the data can be overconservative. That is why it has been argued that one should use a <high>backwards selection procedure</high> (see [Matuschek, Kliegl, Vasishth, Baayen, & Bates](https://www.sciencedirect.com/science/article/pii/S0749596X17300013)).

]

.pull-right45[

<br>

<p align = "center">
<img src="image/maximum_minimum.jpg" height=200px><br>
<font style="font-size:10px">from <a href="https://www.shutterstock.com/de/search/maximum.+minimum.?studio=1">shutterstock.com</a></font>
</p>


]


---

# Fitting Mixed Effects Models in R

.pull-left45[

<br>

Several packages exist to run mixed effects models in R. Here are some of them:

| Package| Function|
|:------|:----|
| [lme4](https://CRAN.R-project.org/package=lme4)| `glmer()` / `lmer()`|
| [afex](https://CRAN.R-project.org/package=afex)| `mixed()`|
| [rstanarm](https://CRAN.R-project.org/package=rstanarm)| `stan_glmer()` / `stan_lmer()` |


]

.pull-right45[

<br>

```{r eval = FALSE}
# mixed model using lme4::lmer()

# fixed effects
LMM_out <- lmer(Tomatometer ~ State +
# by-ID random slopes and intercepts
                  (State|ID) +
# by-ID random slopes and intercepts
                  (State|Movie),
# define data
                data = tomato)

# show output
summary(LMM_out)
```



]

---

# Specifying Random Effects in <high>lme4</high>



Random effects are specified with a new element to the formulas:


| Formula | Meaning |
|:----------|:-------------------|
| `(1 `&#124;` S)` | Random intercepts by `S` |
| `(1 `&#124;` S) + (1 `&#124;` I)` | Random intercepts by `S` and `I`|
| `(X1 `&#124;` S)` OR `(1 + X1`&#124;` S)`| Random intercepts by `S` and random slopes for `X1` by `S` with correlations  |
| `(X1 * X2 `&#124;` S)`| Random intercepts by `S` and random slopes for `X1`, `X2`, and their interaction `X1:X2` by `S` with correlations  |
| `(0 + X1 `&#124;` S)`| Random slopes for `X1`by `S`, no random intercepts |
| `(X1 `&#124;&#124;` S)`| Random intercepts by `S` and random slopes for `X1` by `S` no correlations |
| `(1 `&#124;` S/C)` OR `(1 `&#124;` S) + (1 `&#124;` S:C)`| Random intercepts by `S` and `C` with `C` nested under `S` |

---

# Fitting Mixed Effects Models in R - An Example

.pull-left45[

<br>

We want to predict the <high>Tomatometer</high> rating with <high>State</high> as fixed effect and with by-Subjects (<high>ID</high>) and by-Item (<high>Movie</high>) random slopes and intercepts. 


<p align = "center">
<img src="image/interstellar.png" height=200px><br>
<font style="font-size:10px">from <a href="https://www.rottentomatoes.com/m/interstellar_2014">rottentomatoes.com</a></font>
</p>



]

.pull-right45[

<br>

*What do you think is the correct model specification?*

```{r eval = FALSE}
# mixed model using lme4::lmer()

# fixed effects
LMM_out <- XXX(XXX ~ XXX +
# by-ID random slopes and intercepts
                  (XXX) +
# by-ID random slopes and intercepts
                  (XXX),
# define data
                data = tomato)

# show output
summary(LMM_out)
```

]


---

# Fitting Mixed Effects Models in R - An Example

.pull-left45[

<br>

We want to predict the <high>Tomatometer</high> rating with <high>State</high> as fixed effect and with by-Subjects (<high>ID</high>) and by-Item (<high>Movie</high>) random slopes and intercepts. 

<p align = "center">
<img src="image/interstellar.png" height=200px><br>
<font style="font-size:10px">from <a href="https://www.rottentomatoes.com/m/interstellar_2014">rottentomatoes.com</a></font>
</p>

]

.pull-right45[

<br>

```{r eval = FALSE}
# mixed model using lme4::lmer()

# fixed effects
LMM_out <- lmer(Tomatometer ~ State +
# by-ID random slopes and intercepts
                  (State|ID) +
# by-ID random slopes and intercepts
                  (State|Movie),
# define data
                data = tomato)

# show output
summary(LMM_out)
```



]


---

# `lmer()` Output


<img src="image/lmer_output.png" width="58%" style="display: block; margin: auto;" />

---

# Generalized Mixed Effects Models

<br>

.pull-left55[

In our example we used a <high>linear mixed effects model</high> fitted with `lmer()`. This model assumes a <high>Gaussian</high> (normal) distribution of responses, and an <high>identity</high> link function. But other scenarios are possible. For these we use `glmer()`.

For example, if we had binary data to predict:

```{r eval=FALSE}
# example of a mixed model with binomial
# distribution of the responses and a logit
# link function
glmm_out <- glmer(fasnacht ~ alcohol + (alcohol|id),
                  data = baselers,
                  family = binomial(link = "logit"))

```



]

.pull-right45[

<img src="image/dist_ex_plot.png" width="100%" style="display: block; margin: auto;" />

]

---

# Summary



.pull-left55[

*What are mixed effects models and when do we use them?*

- Mixed effects models are <high>regression models</high> that contain <high>both fixed and random effects</high>.
- They are used when we have <high>repeated measures</high> or <high>clusters</high> in the data.

*When do we add a variable as fixed effect and when as random effect?*

- Fixed effect: when we are interested in the <high>effects of the specific levels</high> in that variable.
- Random effect: when we want to <high>generalize over the levels to the population</high> these levels came from.

]


.pull-left35[

<p align = "center">
<img src="image/MEM_example2.png" height=180px><br>
</p>

<p align = "center">
<img src="image/nested_RE.png" height=130px><br>
</p>

]

---

class: middle, center

<h1><a href="https://therbootcamp.github.io/SwR_2019Apr/_sessions/MixedModels/MixedModels_practical.html">Practical</a></h1>

