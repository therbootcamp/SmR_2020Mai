---
title: "Regression <i>models</i>"
author: "<HmRun style='HmRun-layout:fixed;width:100%;border:0;padding:0;margin:0'><col width='10%'><col width='10%'>
  <tr style='border:none'>
    <td style='display:block;width:100%;text-align:left;vertical-align:bottom;padding:0;margin:0;border:none' nowrap>
      <font style='font-style:normal'>Statistics with R</font><br>
      <a href='https://therbootcamp.github.io/SWR_2019Apr/'>
        <i class='fas fa-clock' style='font-size:.9em;' ></i>
      </a>
      <a href='https://therbootcamp.github.io'>
        <i class='fas fa-home' style='font-size:.9em;'></i>
      </a>
      <a href='mailto:therbootcamp@gmail.com'>
        <i class='fas fa-envelope' style='font-size: .9em;'></i>
      </a>
      <a href='https://www.linkedin.com/company/basel-r-bootcamp/'>
        <i class='fab fa-linkedin' style='font-size: .9em;'></i>
      </a>
      <a href='https://therbootcamp.github.io'>
        <font style='font-style:normal'>Basel R Bootcamp</font>
      </a>
    </td>
    <td style='width:100%;vertical-align:bottom;text-align:right;padding:0;margin:0;border:none'>
      <img src='https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/by-sa.png' style='height:15px;width:80px'/>
    </td>
  </tr></HmRun>"
output:
  html_document:
    css: practical.css
    self_contained: no
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(comment = NA, 
                      fig.width = 6, 
                      fig.height = 6,
                      fig.align = 'center',
                      echo = FALSE, 
                      eval = FALSE, 
                      warning = FALSE)

options(digits = 3)

# Load packages
library(tidyverse)

# Load packages
college <- read_csv("1_Data/college.csv")
hitters <- read_csv("1_Data/hitters.csv")
```

<p align="center" width="100%">
  <img src="image/placeholder.png" alt="Trulli" style="width:100%;height:280px">
  <br>
  <font style="font-size:10px">from <a href="">shortened URL</a></font>
</p>


# {.tabset}

## Overview

In this practical you'll practice "XXX" with the `XXX` packages.

By the end of this practical you will know how to:

1. 
2. 
3.

## Tasks

### A - Setup

1. Open your `BaselRBootcamp` R project. It should already have the folders `1_Data` and `2_Code`. Make sure that the data files listed in the `Datasets` section above are in your `1_Data` folder

```{r}
# Done!
```

2. Open a new R script. At the top of the script, using comments, write your name and the date. Save it as a new file called `regression_models_practical.R` in the `2_Code` folder.  

```{r}
# Done!
```

3. Using `library()` load the `tidyverse`, `broom` and `ggpubr` packages (if you don't have them, you'll need to install them with `install.packages()`)!

```{r, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}
# Load packages necessary for this script
library(tidyverse)
library(broom)
library(ggpubr)
```

4. Using the following template, load the `hitters.csv` data into R and store it as a new object called `hitters` (Hint: Don't type the path directly! Use the "tab" completion!).

```{r, echo = TRUE}
# Load XXX.csv from the 1_Data folder

XX <- read_csv(file = "XX/XX")
```

```{r}
hitters <- read_csv("1_Data/hitters.csv")
```

5. Take a look at the first few rows of the dataset(s) by printing it/them to the console.

```{r, echo = TRUE}
# Print hitters object
XXX
```

```{r}
hitters
```

7. Use the `View()` function to view the entire dataframe(s) in new window(s).

```{r, echo = TRUE, eval = FALSE}
View(XXX)
```

### B - Simple regression

#### Hits and Salary

In this section, we will answer the question: "Is there a relationship between the number of Hits a player had in 1986 (`Hits`) and his salary in 1987 (`Salary`)"?

1. Using the code below, create a scatterplot showing the relationship between Hits and Salary. Based on this plot, do you expect there to be a relationship between these variables?

```{r, echo = TRUE, eval = FALSE}
ggplot(hitters, aes(x = Hits, y = Salary)) +
  geom_point() +
  theme_minimal()
```

2. Using the guide below, conduct a regression analysis predicting a player's `Salary` as a function of his `Hits` value. Save the result to an object called `hits_glm`.

```{r, eval = FALSE, echo = TRUE}
carat_glm <- glm(formula = XXX ~ XXX,
             data = XXX)
```

```{r}
hits_glm <- glm(formula = Salary ~ Hits,
                   data = hitters)
```


3. Look at the class of your `hits_glm` object using the `class()` function. What class is the object?

```{r, echo = TRUE, eval = FALSE}
# Print the class of the hits_glm object

class(XXX)
```

```{r}
class(hits_glm)
```

4. Print your `hits_glm` object to see summary information. What is the value of the coefficient for Hits and what does it mean? Is it consistent with what you expected from the plot?

```{r}
hits_glm
```

5. Use the `summary()` function to print additional summary information from your `hits_glm` object.

```{r, echo = TRUE, eval = FALSE}
# Show summary information from hits_glm
summary(XXX)
```

```{r}
summary(hits_glm)
```

6. Using the `tidy()` function (from the broom package), create a new object called `hits_tidy` which contains all 'tidy' results from your `hits_glm` object.

```{r, echo = TRUE, eval = FALSE}
# Save 'tidy' results from hits_glm as hits_tidy
hits_tidy <- tidy(XXX)
```

```{r}
hits_tidy <- tidy(hits_glm)
```

6. Print your `hits_tidy` object, which statistical outputs do you see?

```{r}
hits_tidy
```

7. What is the p-value associated with your `Hits` coefficient? How do you interpret this? Do you think that, in the general population of players, that there is a non-zero relationship between hits and salary?

```{r}
# The p-value is 0.0382 which is 'significant' at the 0.05 level.
#  We do expect there to be a positive relationship between hits and salary in all players
```

8. Using the `confint()` function, print a 95% confidence interval for the regression coefficients in your `HmRun_glm` object. What does this mean?

```{r, echo = TRUE, eval = FALSE}
# Print confidence interval(s) of coefficient(s) in hits_glm
confint(XXX)
```

```{r}
confint(hits_glm)

# The confidence interval ranges from 0.26 to 6.13
```

9. Using the `fitted()` function, save the fitted values of your `glm` object as `Hits_fit`. Then print the results to see how they look. 

```{r, echo = TRUE, eval = FALSE}
# Save fitted values from Hits_glm as Hits_fit
Hits_fit <- fitted(XXX)

# Print results
Hits_fit
```

```{r}
Hits_fit <- fitted(hits_glm)

Hits_fit
```

10. Using `min()`, `max()`, `mean()`, `median()`, and `sd()`, calculte summary statistics for the fits. Do the values look like they make sense?

```{r, echo = TRUE, eval = FALSE}
# Print summary statistics from Hits_fit

min(XXX)
max(XXX)
mean(XXX)
median(XXX)
sd(XXX)
```

```{r}
min(Hits_fit)
max(Hits_fit)
mean(Hits_fit)
median(Hits_fit)
sd(Hits_fit)
```

11. Using the code below, plot the relationship between the model fitted values and the true values

```{r, echo = TRUE, eval = FALSE}
# Create dataframe containing true salaries and model fits

data <- tibble(truth = hitters$Salary,
               fitted  = Hits_fit)

# Create scatterplot
ggplot(data = data, aes(x = truth, y = fitted)) +  
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(title = "Relationship between model fits and true Salaries",
       subtitle = "Formula = Salary ~ Hits") +
  geom_segment(aes(x = truth, y = truth, xend = truth, yend = fitted), 
               col = "red") +
  xlim(c(-300, 3000)) +
  ylim(c(-300, 3000))
```

12. Using the `rsq()` function, print the r-squared value from your object. How much of the variance in Salary can your model account for? Is this high or low?

```{r, echo = TRUE, eval = FALSE}
# Print r-squared value from hits_glm object
rsq(XXX)
```

```{r}
rsq(hits_glm)
```

#### HmRun 

In this section, we will answer the question: "Is there a relationship between the number of home runs a player scores in 1986 his salary in 1987?

1. Using the code below, create a scattplot showing the relationship between HmRun and Salary. Based on this plot, what do you expect the relationship to be between HmRun and Salary?

```{r, echo = TRUE, eval = FALSE}
ggplot(hitters, aes(x = HmRun, y = Salary)) +
  geom_point() +
  theme_minimal()
```

2. Conduct a regression analysis predicting a diamond's `Salary` as a function of its `HmRun` value. Save the result to an object called `HmRun_glm`.

```{r, echo = TRUE, eval = FALSE}
HmRun_glm <- glm(formula = XXX ~ XXX,
                 data = XXX)
```

```{r}
HmRun_glm <- glm(formula = Salary ~ HmRun,
                 data = hitters)
```

3. Print your `HmRun_glm` object to see summary information. What is the value of the beta weight for HmRun and what does it mean? Is it consistent with what you saw in the plot?

```{r}
HmRun_glm
```

4. Use the `summary()` function to print additional summary information from your `HmRun_glm` object.

```{r, echo = TRUE, eval = FALSE}
summary(XXX)
```

```{r}
summary(HmRun_glm)
```

5. Using the `tidy()` function (from the broom package), create a new object called `HmRun_tidy` which contains all 'tidy' results from your `HmRun_glm` object.

```{r, echo = TRUE, eval = FALSE}
HmRun_tidy <- tidy(XXX)
```

```{r}
HmRun_tidy <- tidy(HmRun_glm)
```

6. Print your `HmRun_tidy` object, which statistical outputs do you see?

```{r}
HmRun_tidy
```

7. What is the p-value associated with your `HmRun` coefficient? How do you interpret this? Do you think that, in the general population of players, that there is a non-zero relationship between HmRun and Salary?

8. Using the `confint()` function, print a 95% confidence interval for the regression coefficients in your `HmRun_glm` object. What does this mean?

```{r, echo = TRUE, eval = FALSE}
confint(XXX)
```

```{r}
confint(HmRun_glm)
```

9. Using the `fitted()` function, save the fitted values of your `glm` object as `HmRun_fit`. Then print the results to see how they look.

```{r, echo = TRUE, eval = FALSE}
# Save fitted values from HmRun_glm as HmRun_fit
HmRun_fit <- fitted(XXX)

# Print results
HmRun_fit
```

```{r}
HmRun_fit <- fitted(HmRun_glm)

HmRun_fit
```

10. Using `min()`, `max()`, `mean()`, `median()`, and `sd()`, calculte summary statistics for the fits. Do the values look like they make sense?

```{r, echo = TRUE, eval = FALSE}
min(XXX)
max(XXX)
mean(XXX)
median(XXX)
sd(XXX)
```

```{r}
min(HmRun_fit)
max(HmRun_fit)
mean(HmRun_fit)
median(HmRun_fit)
sd(HmRun_fit)
```

11. Using the code below, plot the relationship between the model fitted values and the true values

```{r, echo = TRUE, eval = FALSE}
data <- tibble(truth = hitters$Salary,
               fitted  = HmRun_fit)

ggplot(data = data, aes(x = truth, y = fitted)) +  
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(title = "Relationship between model fits and true Salaries",
       subtitle = "Formula = Salary ~ HmRun") +
  geom_segment(aes(x = truth, y = truth, xend = truth, yend = fitted), 
               col = "red") +
  xlim(c(-300, 3000)) +
  ylim(c(-300, 3000))
```

12. Using the `rsq()` function, print the r-squared value from your object. What does this tell you?

```{r, echo = TRUE, eval = FALSE}
rsq(XXX)
```

```{r}
rsq(HmRun_glm)
```

### C - Multiple IVs

1. Create an object called `Salary_glm` which predicts price based on *all* variables in the `hitters` dataframe. Assign the result to an object called `all_glm`.Use the following guide to help you:

```{r, eval = FALSE, echo = TRUE}
all_glm <- glm(formula = XXX ~ .,
              data = XXX)
```

```{r}
all_glm <- glm(formula = Salary ~ .,
                 data = hitters)
```

2. Using the `tidy()` function (from the broom package), create a new object called `all_tidy` which contains all 'tidy' results from your `all_glm` object.

```{r}
all_tidy <- tidy(all_glm)
```

3. Print your `all_tidy` object.

```{r}
all_tidy
```

4. How do you interpret the results? Which variables appear to be related to salary? 

5. Using the `confint()` function, print a 95% confidence interval for the regression coefficients in your `all_glm` object. What does this mean?

```{r}
confint(XXX)
```

```{r}
confint(all_glm)
```

9. Using the `fitted()` function, save the fitted values of your `glm` object as `All_fit`. Then print the results to see how they look.

```{r, echo = TRUE, eval = FALSE}
# Save fitted values from All_glm as All_fit
All_fit <- fitted(XXX)

# Print results
All_fit
```

```{r}
All_fit <- fitted(all_glm)

All_fit
```

10. Using `min()`, `max()`, `mean()`, `median()`, and `sd()`, calculte summary statistics for the fits. Do the values look like they make sense?


```{r, echo = TRUE, eval = FALSE}
min(XXX)
max(XXX)
mean(XXX)
median(XXX)
sd(XXX)
```

```{r}
min(All_fit)
max(All_fit)
mean(All_fit)
median(All_fit)
sd(All_fit)
```

11. Using the code below, plot the relationship between the model fitted values and the true values

```{r, echo = TRUE, eval = FALSE}
data <- tibble(truth = hitters$Salary,
               fitted  = All_fit)

ggplot(data = data, aes(x = truth, y = fitted)) +  
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(title = "Relationship between model fits and true Salaries",
       subtitle = "Formula = Salary ~ .") +
  geom_segment(aes(x = truth, y = truth, xend = truth, yend = fitted), 
               col = "red") +
  xlim(c(-300, 3000)) +
  ylim(c(-300, 3000))
```

12. Using the `rsq()` function, print the r-squared value from your object. What does this tell you?

```{r, echo = TRUE, eval = FALSE}
rsq(XXX)
```

```{r}
rsq(HmRun_glm)
```

### E - Exploring model residuals

1. Using the `resid()` function, save the residuals of your regression analysis to a vector called `all_resid`

```{r, echo = TRUE, eval = FALSE}
all_resid <- resid(XXX)
```

```{r}
all_resid <- resid(all_glm)
```

2. Using the `min()`, `max()`, `mean()`, `median()` and `sd()` functions, calculate the summary statistics of the residuals `all_resid`. Do the values look like they make sense?

3. Using the following code, create a histogram of the residuals from your `all_glm` object

```{r, echo = TRUE, eval = FALSE}
# Create a dataframe containing absolute errors
data <- tibble(resid = all_resid)

ggplot(data, aes(x = resid)) + 
  geom_histogram(col = "white") +
  geom_vline(xintercept = 0, col = "red") +
  labs(title = "Residuals of Salary GLM")
```

4. Using the `abs()` function, create a new vector called `all_abs_resid` which contains the *absolute* residuals. Use the following guide

```{r, echo = TRUE, eval = FALSE}
all_resid <- abs(resid(XXX))
```

```{r}
all_abs_resid <- abs(resid(all_glm))
```

5. Using `min()`, `max()`, `mean()`, `median()`, and `sd()`, calculte summary statistics for the absolute residuals `all_abs_resid`. Do the values look like they make sense?

```{r}
min(all_abs_resid)
max(all_abs_resid)
mean(all_abs_resid)
median(all_abs_resid)
sd(all_abs_resid)
```

5. Using the following code, Create a histogram of the absolute residuals `all_abs_resid`. How do you interpret this plot?

```{r, echo = TRUE, eval = FALSE}
# Create a dataframe containing absolute errors
data <- tibble(abs_resid = all_abs_resid)

ggplot(data, aes(x = abs_resid)) + 
  geom_histogram(col = "white") +
  geom_vline(xintercept = 0, col = "red") +
  labs(title = "Absolute Residuals of Salary GLM")
```

### F - Adjusting your model with formulas

### Excluding variables with -

1. Using the guides below, create a regression object `my_glm` predicting Salary based on all variables *except* for `AtBat` and `Hits`

```{r, eval = FALSE, echo = TRUE}
my_glm <- glm(formula = XXX ~ . - XXX - XXX,
              data = XXX)
```

```{r}
my_glm <- glm(formula = Salary ~ . - AtBat - Hits,
              data = hitters)
```

2. Using the `tidy()` function, print tidy results from your `my_glm` object, do you see that the variables you excluded are indeed not in the model?

```{r}
tidy(my_glm)
```

### G - Predicting values for new data

1. The `hitters_new.csv` file contains values from 10 new players, load this data as a new dataframe called `hitters_new`

```{r, echo = TRUE, eval = FALSE}
hitters_new <- read_csv("XXX/XXX")
```

```{r}
hitters_new <- read_csv("1_Data/hitters_new.csv")
```

2. Print the `hitters_new` dataframe to see how it looks.

3. Using the following code, print only the values of Salary and hits

```{r, echo = TRUE, eval = FALSE}
hitters_new %>%
  select(Salary, Hits)
```

3. You should have already created your `hits_glm` object in an earlier question. Print your `hits_glm` object again to see what the model coefficients are.

4. Based on the coefficients you've observed, what should the predicted value of the first player in `hitters_new` be (hint: Salary = Intercept + Coefficient * Hits)

5. Using your `hits_glm` object, predict the salaries of these new players using the `predict()` function. Save the results to an object called `hitters_new_pred`:

```{r, echo = TRUE, eval = FALSE}
hitters_new_pred <- predict(object = XXX,    # glm object
                            newdata = XXX)   # New dataframe
```

```{r}
predict(object = hits_glm, 
        newdata = hitters_new)
```

6. Print your `hitters_new_pred` object, what are these values?

```{r}
hitters_new_pred
```

7. Does the first value match the value you calculated by hand?

## Examples

```{r, eval = FALSE, echo = TRUE}

# EXAMPLE CODE

```


## Datasets

|File | Rows | Columns |
|:----|:-----|:------|
|[XXX]() | Nrow | Ncol |
|[XXX]() | Nrow | Ncol |

SHORT VERBAL DESCRIPTION OF DATA SETS

#### Variable description

| Name | Description |
|:-------------|:-------------------------------------|
| XXX | XXX |
| XXX | age in years at baseline|
|wtkg| weight in kg at baseline|
|hemo| hemophilia (0=no, 1=yes)|
|homo| homosexual activity (0=no, 1=yes)|
|drugs| history of intravenous drug use (0=no, 1=yes)|
|karnof| Karnofsky score (on a scale of 0-100)|
|oprior| non-zidovudine antiretroviral therapy prior to initiation of study treatment (0=no, 1=yes)|
|z30| zidovudine use in the 30 days prior to treatment initiation (0=no, 1=yes)|
|zprior| zidovudine use prior to treatment initiation (0=no, 1=yes)|
|preanti| number of days of previously received antiretroviral therapy|
|race| race (0=white, 1=non-white)|
|gender| gender (0=female, 1=male)|
|str2| antiretroviral history (0=naive, 1=experienced)|
|strat| antiretroviral history stratification (1=’antiretroviral naive’, 2=’> 1 but ≤ 52 weeks of prior antiretroviral therapy’, 3=’> 52 weeks’)|
|symptom| symptomatic indicator (0=asymptomatic, 1=symptomatic)|
|treat| treatment indicator (0=zidovudine only, 1=other therapies)|
|offtrt| indicator of off-treatment before 96±5 weeks (0=no,1=yes)|
|cd40| CD4 T cell count at baseline|
|cd420| CD4 T cell count at 20±5 weeks|
|cd496| CD4 T cell count at 96±5 weeks (=NA if missing)|
|r| missing CD4 T cell count at 96±5 weeks (0=missing, 1=observed)|
|cd80| CD8 T cell count at baseline|
|cd820| CD8 T cell count at 20±5 weeks|
|cens| indicator of observing the event in days|
|days| number of days until the first occurrence of: (i) a decline in CD4 T cell count of at least 50 (ii) an event indicating progression to AIDS, or (iii) death.|
|arms| treatment arm (0=zidovudine, 1=zidovudine and didanosine, 2=zidovudine and zalcitabine, 3=didanosine).|

## Functions

### Packages

|Package| Installation|
|:------|:------|
|`tidyverse`|`install.packages("tidyverse")`|
| `broom` | `install.packages("tidyverse")` |
| `rsq` | `install.packages("rsq")` |


### Functions

| Function| Package | Description |
|:---|:------|:---------------------------------------------|
|     `XXX`|`XXX`| XXX | 
|     `XXX`|`XXX`| XXX | 

## Resources

### vignettes

TEXT and LINKS

### Cheatsheets

<p align="center" width="100%">
<a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">
  <img src="https://image.slidesharecdn.com/data-wrangling-cheatsheet-160705210122/95/data-wrangling-with-dplyr-and-tidyr-cheat-sheet-1-638.jpg?cb=1467752577" style="width:70%"></a>
  <br>
  <font style="font-size:10px">from <a href="https://www.rstudio.com/resources/cheatsheets/">R Studio</a></font>
</p>
